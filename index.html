<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"onos.love","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="记录工作内容,分享技术经验">
<meta property="og:type" content="website">
<meta property="og:title" content="正经技术">
<meta property="og:url" content="http://onos.love/index.html">
<meta property="og:site_name" content="正经技术">
<meta property="og:description" content="记录工作内容,分享技术经验">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="xuy">
<meta property="article:tag" content="运维,代码,架构,软件">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://onos.love/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>正经技术</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">正经技术</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">分享技术经验</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">3</span></a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">12</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">12</span></a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">xuy</p>
  <div class="site-description" itemprop="description">记录工作内容,分享技术经验</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://onos.love/2022/02/21/frp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xuy">
      <meta itemprop="description" content="记录工作内容,分享技术经验">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经技术">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/21/frp/" class="post-title-link" itemprop="url">Frp内网穿透环境部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-02-21 14:35:12 / 修改时间：15:21:11" itemprop="dateCreated datePublished" datetime="2022-02-21T14:35:12+08:00">2022-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BD%AF%E4%BB%B6%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">软件部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>1，frp下载地址：<a target="_blank" rel="noopener" href="https://github.com/fatedier/frp/releases">https://github.com/fatedier/frp/releases</a></p>
<p>2，架构示意图：</p>
<p><img src="/2022/02/21/frp/image-20220221143938805.png" alt="image-20220221143938805"></p>
<p>3，配置文件:</p>
<ul>
<li><p>服务端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/frp/frps.ini</span></span><br><span class="line"></span><br><span class="line">[common]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务端口</span></span><br><span class="line">bind_port = 23569</span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志位置</span></span><br><span class="line">log_file = /var/log/frps.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端连接服务端的秘钥</span></span><br><span class="line">token = password</span><br><span class="line"></span><br><span class="line">[common]</span><br><span class="line">dashboard_port = 7500</span><br><span class="line"><span class="meta">#</span><span class="bash"> dashboard<span class="string">&#x27;s username and password are both optional</span></span></span><br><span class="line">dashboard_user = username</span><br><span class="line">dashboard_pwd = password</span><br></pre></td></tr></table></figure></li>
<li><p>客户端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/frp/frpc.ini</span></span><br><span class="line"></span><br><span class="line">[common]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务端IP</span></span><br><span class="line">server_addr = 81.68.245.218</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务端端口</span></span><br><span class="line">server_port = 23569</span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志位置 可不写</span></span><br><span class="line">log_file = /var/log/frps.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开加密</span></span><br><span class="line">tls_enable = true</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端连接服务端的秘钥</span></span><br><span class="line">token = password</span><br><span class="line"></span><br><span class="line">[节点1]</span><br><span class="line">type = tcp</span><br><span class="line">local_port = 2641</span><br><span class="line">remote_port = 2641</span><br><span class="line"></span><br><span class="line">[节点2]</span><br><span class="line">type = tcp</span><br><span class="line">local_ip = 10.63.129.11</span><br><span class="line">local_port = 22</span><br><span class="line">remote_port = 18080</span><br></pre></td></tr></table></figure></li>
</ul>
<p>4，注册为CentOS系统服务，一下仅以服务端为例，客户端同理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入路径</span></span><br><span class="line">cd ~</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建frp文件夹</span></span><br><span class="line">mkdir frp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建服务文件</span></span><br><span class="line">vi frps.service </span><br><span class="line"><span class="meta">#</span><span class="bash"> 编辑内容如下</span> </span><br><span class="line">[Unit]</span><br><span class="line">Description=Frp Server Service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=nobody</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5s</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务端执行文件 和 配置文件地址</span></span><br><span class="line">ExecStart=/usr/bin/frps -c /etc/frp/frps.ini</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 完成服务文件编写后</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝到服务目录</span></span><br><span class="line">cp frps.service /etc/systemd/system/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 赋权限</span></span><br><span class="line">chmod u+x /etc/systemd/system/frps.service</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重载服务</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开机自启</span></span><br><span class="line">systemctl enable frps</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">systemctl enable frps</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://onos.love/2022/02/21/%E5%9C%A8K8S%E4%B8%AD%E9%83%A8%E7%BD%B2Nacos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xuy">
      <meta itemprop="description" content="记录工作内容,分享技术经验">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经技术">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/21/%E5%9C%A8K8S%E4%B8%AD%E9%83%A8%E7%BD%B2Nacos/" class="post-title-link" itemprop="url">在K8S中部署Nacos</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-02-21 14:30:31 / 修改时间：14:31:12" itemprop="dateCreated datePublished" datetime="2022-02-21T14:30:31+08:00">2022-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">容器技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/%E8%BD%AF%E4%BB%B6%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">软件部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="在K8S中部署Nacos"><a href="#在K8S中部署Nacos" class="headerlink" title="在K8S中部署Nacos"></a>在K8S中部署Nacos</h1><h2 id="准备文件资料"><a href="#准备文件资料" class="headerlink" title="准备文件资料"></a>准备文件资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/use-nacos-with-kubernetes.html">https://nacos.io/zh-cn/docs/use-nacos-with-kubernetes.html</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/nacos-group/nacos-k8s">https://github.com/nacos-group/nacos-k8s</a></li>
</ul>
<h2 id="部署Nacos"><a href="#部署Nacos" class="headerlink" title="部署Nacos"></a>部署Nacos</h2><ul>
<li>1，部署NFS</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建角色</span></span><br><span class="line">kubectl create -f deploy/nfs/rbac.yaml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果的K8S命名空间不是default，请在部署RBAC之前执行以下脚本:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set the subject of the RBAC objects to the current namespace <span class="built_in">where</span> the provisioner is being deployed</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> NS=$(kubectl config get-contexts|grep -e <span class="string">&quot;^\*&quot;</span> |awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> NAMESPACE=<span class="variable">$&#123;NS:-default&#125;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sed -i<span class="string">&#x27;&#x27;</span> <span class="string">&quot;s/namespace:.*/namespace: <span class="variable">$NAMESPACE</span>/g&quot;</span> ./deploy/nfs/rbac.yaml</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建 ServiceAccount 和部署 NFS-Client Provisioner</span></span><br><span class="line">kubectl create -f deploy/nfs/deployment.yaml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建 NFS StorageClass</span></span><br><span class="line">kubectl create -f deploy/nfs/class.yaml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证NFS部署成功</span></span><br><span class="line">kubectl get pod -l app=nfs-client-provisioner</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 部署数据库</span></span><br><span class="line">kubectl apply -f deploy/mysql/mysql-nfs.yaml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 部署Nacos</span></span><br><span class="line">kubectl apply -f deploy/nacos/nacos-pvc-nfs.yaml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证Nacos节点启动成功</span></span><br><span class="line">kubectl get pod -l app=nacos</span><br><span class="line"></span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nacos-0   1/1     Running   0          19h</span><br><span class="line">nacos-1   1/1     Running   0          19h</span><br><span class="line">nacos-2   1/1     Running   0          19h</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="将-headless-service-映射到外网"><a href="#将-headless-service-映射到外网" class="headerlink" title="将 headless service 映射到外网"></a>将 headless service 映射到外网</h2><p>nacos服务在Kubernetes体系中，默认使用headless service</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc nacos-headless</span><br><span class="line"></span><br><span class="line">NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                               AGE</span><br><span class="line">nacos-headless   ClusterIP   None         &lt;none&gt;        8848/TCP,9848/TCP,9849/TCP,7848/TCP   20h</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有两种方法把Nacos的管理界面映射到集群外</p>
<ul>
<li>1，将 nacos-headless service 通过负载均衡映射到外网</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">kubectl expose service  nacos-headless --type=LoadBalancer --name=nacos-external-lb</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证</span></span><br><span class="line">kubectl get svc nacos-external-lb</span><br><span class="line">NAME                TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                       AGE</span><br><span class="line">nacos-external-lb   LoadBalancer   10.107.11.100   &lt;pending&gt;     8848:31377/TCP,9848:31534/TCP,9849:32656/TCP,7848:30294/TCP   4h23m</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>2，仅将8848端口通过负载均衡映射到外网</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose svc nacos-headless  --name=nacos-external  --type=LoadBalancer  --port=8848 --target-port=8848</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证</span></span><br><span class="line">kubectl get svc nacos-external</span><br><span class="line">NAME             TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)          AGE</span><br><span class="line">nacos-external   LoadBalancer   172.16.254.50   175.24.254.201   8848:30291/TCP   38s</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看详情</span></span><br><span class="line">kubectl describe svc nacos-external</span><br><span class="line">Name:                     nacos-external</span><br><span class="line">Namespace:                default</span><br><span class="line">Labels:                   app=nacos-headless</span><br><span class="line">Annotations:              service.kubernetes.io/loadbalance-id: lb-696gr02t</span><br><span class="line">Selector:                 app=nacos</span><br><span class="line">Type:                     LoadBalancer</span><br><span class="line">IP Families:              &lt;none&gt;</span><br><span class="line">IP:                       172.16.254.50</span><br><span class="line">IPs:                      &lt;none&gt;</span><br><span class="line">LoadBalancer Ingress:     175.24.254.201</span><br><span class="line">Port:                     &lt;unset&gt;  8848/TCP</span><br><span class="line">TargetPort:               8848/TCP</span><br><span class="line">NodePort:                 &lt;unset&gt;  30291/TCP</span><br><span class="line">Endpoints:                172.16.0.10:8848,172.16.0.135:8848,172.16.0.73:8848</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://onos.love/2022/02/21/JupyterHub%E8%87%AA%E5%AE%9A%E4%B9%89magic%E5%8F%8A%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xuy">
      <meta itemprop="description" content="记录工作内容,分享技术经验">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经技术">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/21/JupyterHub%E8%87%AA%E5%AE%9A%E4%B9%89magic%E5%8F%8A%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">JupyterHub自定义magic及部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-02-21 14:15:03 / 修改时间：14:18:04" itemprop="dateCreated datePublished" datetime="2022-02-21T14:15:03+08:00">2022-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BD%AF%E4%BB%B6%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">软件部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="自定义magic制作及部署方案"><a href="#自定义magic制作及部署方案" class="headerlink" title="自定义magic制作及部署方案"></a>自定义magic制作及部署方案</h1><h2 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h2><ul>
<li>Notebook中使用自定义magic</li>
<li>样例以mysql数据库连接为例</li>
</ul>
<h2 id="方案一：用户自定义形式"><a href="#方案一：用户自定义形式" class="headerlink" title="方案一：用户自定义形式"></a>方案一：用户自定义形式</h2><h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><ul>
<li>个人环境自使用</li>
</ul>
<h3 id="自定义magic：mysqlmagic的代码-mysqlmagic-py"><a href="#自定义magic：mysqlmagic的代码-mysqlmagic-py" class="headerlink" title="自定义magic：mysqlmagic的代码 mysqlmagic.py"></a>自定义magic：mysqlmagic的代码 mysqlmagic.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> IPython.core.magic <span class="keyword">import</span> (</span><br><span class="line">    cell_magic,</span><br><span class="line">    Magics,</span><br><span class="line">    magics_class</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@magics_class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mysqlmagics</span>(<span class="params">Magics</span>):</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">## 读取数据1</span></span><br><span class="line"><span class="comment">#db = pymysql.connect(host=&#x27;192.168.144.250&#x27;,user=&#x27;root&#x27;,password=&#x27;1qaz@WSX&#x27;,database=&#x27;actuator&#x27;,charset=&#x27;utf8&#x27;)</span></span><br><span class="line"><span class="comment">#data = pd.read_sql(&#x27;select * from tt_algorithm_model_file&#x27;,con=db)</span></span><br><span class="line"><span class="comment">#print(data)</span></span><br><span class="line"><span class="comment">#db.close()           #关闭连接</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义默认连接参数</span></span><br><span class="line">    pg_default = &#123;</span><br><span class="line">        <span class="string">&#x27;database&#x27;</span>: <span class="string">&#x27;actuator&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;host&#x27;</span>: <span class="string">&#x27;192.168.144.250&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;port&#x27;</span>: <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;1qaz@WSX&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;charset&#x27;</span>:<span class="string">&#x27;utf8&#x27;</span></span><br><span class="line"><span class="comment"># host: 这个是ip地址，因为我这里是本地的，所以填127.0.0.1，也可以填localhost。</span></span><br><span class="line"><span class="comment"># user：用户名，如果你也是本地的，就填root好了</span></span><br><span class="line"><span class="comment"># passwd：这个是密码</span></span><br><span class="line"><span class="comment"># db：这个是数据库名</span></span><br><span class="line"><span class="comment"># port：这个是端口，本地的一般都是3306</span></span><br><span class="line"><span class="comment"># charset：这个是编码方式，要和你数据库的编码方式一致，要不会连接失败</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 返回greenplum连接对象</span></span><br><span class="line">        <span class="comment"># pymysql.connect(host=&#x27;192.168.144.250&#x27;,user=&#x27;root&#x27;,password=&#x27;1qaz@WSX&#x27;,database=&#x27;actuator&#x27;,charset=&#x27;utf8&#x27;)</span></span><br><span class="line">        <span class="keyword">return</span> pymysql.connect(</span><br><span class="line">            database=self.pg_default[<span class="string">&#x27;database&#x27;</span>],</span><br><span class="line">            host=self.pg_default[<span class="string">&#x27;host&#x27;</span>],</span><br><span class="line">            port=<span class="built_in">int</span>(self.pg_default[<span class="string">&#x27;port&#x27;</span>]),</span><br><span class="line">            user=self.pg_default[<span class="string">&#x27;user&#x27;</span>],</span><br><span class="line">            password=self.pg_default[<span class="string">&#x27;password&#x27;</span>],</span><br><span class="line">            charset=self.pg_default[<span class="string">&#x27;charset&#x27;</span>]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment">#使用 cell_magic 修饰greenplum方法, 还可以用 line_magic或者line_cell_magic</span></span><br><span class="line"><span class="meta">    @cell_magic</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mysqlmagic</span>(<span class="params">self, line=<span class="string">&#x27;&#x27;</span>, cell=<span class="literal">None</span></span>):</span></span><br><span class="line">        sql = cell</span><br><span class="line">        k = self.connect()</span><br><span class="line">        kursor = k.cursor()</span><br><span class="line">        kursor.execute(sql)</span><br><span class="line">        <span class="comment"># 将返回数据放入 pandas, 这样在jupyter页面返回时会更美观一些</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pd.set_option(<span class="string">&#x27;display.max_columns&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">            pd.set_option(<span class="string">&#x27;display.max_rows&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">            results = kursor.fetchall()</span><br><span class="line">            <span class="keyword">return</span> pd.DataFrame(results)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> pd.DataFrame([])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册自定义magic类到正在运行的ipython里面</span></span><br><span class="line">ipy = get_ipython()</span><br><span class="line">ipy.register_magics(Mysqlmagics)</span><br></pre></td></tr></table></figure>

<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><ul>
<li>1.直接在notebook中单元格使用</li>
<li>2.单独文件直接执行后也可以在工程内使用</li>
<li>3.将.py文件放入个人的~.ipython\profile_default\startup目录下，每次ipython运行之前都会被自动运行一遍</li>
</ul>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%%mysqlmagic</span><br><span class="line">select * from tt_algorithm_model_file</span><br></pre></td></tr></table></figure>

<h2 id="方案二：第三方工具包形式"><a href="#方案二：第三方工具包形式" class="headerlink" title="方案二：第三方工具包形式"></a>方案二：第三方工具包形式</h2><h3 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a>适用场景</h3><ul>
<li>各用户环境通用,且方便修改和部署，无需重启jupyter</li>
<li>代码可参考<a target="_blank" rel="noopener" href="https://github.com/liuweibin6566396837/spark_magic-py-master">https://github.com/liuweibin6566396837/spark_magic-py-master</a></li>
</ul>
<h3 id="在当前环境中安装spark-magic"><a href="#在当前环境中安装spark-magic" class="headerlink" title="在当前环境中安装spark magic"></a>在当前环境中安装spark magic</h3><ul>
<li>第一步：从gitlab下载<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">地址: https://github.com/liuweibin6566396837/spark_magic-py-master</span><br></pre></td></tr></table></figure></li>
<li>第二步: 切换到需要安装工具包的环境<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">例如:</span><br><span class="line">source /opt/app/anaconda3/bin/activate</span><br></pre></td></tr></table></figure></li>
<li>第三步: setup安装工具包</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">切换到spark_magic-py-master/根目录下 执行：</span><br><span class="line">python setup.py build</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>

<ul>
<li>第四步: 拷贝模块到当前环境的site-package下</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">一般来说，第四步是不需要的，但是site-package下没有自动生成spark_magic模块工具包(哪位大佬知晓，可以告知一下)</span><br><span class="line"></span><br><span class="line">cp -r spark_magic xxx/site-packages</span><br><span class="line">使用pip list可以看到spark-magic模块 安装成功！！！</span><br><span class="line"></span><br><span class="line">注意：在console中直接引包会出现NameError: name &#x27;get_ipython&#x27; is not defined错误无需理会，这是由于当前没有ipython进程获取不到该进程，而在jupyter起服务时会起该进程</span><br></pre></td></tr></table></figure>

<h3 id="在notebook中如何调用spark-magic"><a href="#在notebook中如何调用spark-magic" class="headerlink" title="在notebook中如何调用spark magic"></a>在notebook中如何调用spark magic</h3><ul>
<li>第一步：引入spark magic 第三方工具</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from spark_magic.sparkmagic import *</span><br></pre></td></tr></table></figure>
<ul>
<li>第二步：调用spark line magic(默认配置) 或者 cell magic(自定义配置)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">%pyspark           # line magic</span><br><span class="line">%%pyspark          # cell magic</span><br><span class="line">spark.app.name:jupyter-user</span><br><span class="line">spark.pyspark.driver.python:/opt/app/anaconda3/bin/python</span><br><span class="line">spark.pyspark.python:/opt/app/anaconda3/bin/python</span><br><span class="line">spark.driver.memory:2g</span><br><span class="line">spark.executor.memory:2g</span><br><span class="line">spark.executor.cores:3</span><br><span class="line">spark.executor.instances:1</span><br></pre></td></tr></table></figure>

<ul>
<li>第三步：引用会话</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spark, sc = _</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="方案三：IPython底层修改源码形式"><a href="#方案三：IPython底层修改源码形式" class="headerlink" title="方案三：IPython底层修改源码形式"></a>方案三：IPython底层修改源码形式</h2><h3 id="适用场景-2"><a href="#适用场景-2" class="headerlink" title="适用场景"></a>适用场景</h3><ul>
<li>各用户环境通用,但修改需要重启jupyter</li>
</ul>
<h3 id="自定义magic：mysqlmagic2的代码-mysqlmagic2-py"><a href="#自定义magic：mysqlmagic2的代码-mysqlmagic2-py" class="headerlink" title="自定义magic：mysqlmagic2的代码 mysqlmagic2.py"></a>自定义magic：mysqlmagic2的代码 mysqlmagic2.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pformat</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> IPython.core <span class="keyword">import</span> magic_arguments</span><br><span class="line"><span class="keyword">from</span> IPython.core <span class="keyword">import</span> oinspect</span><br><span class="line"><span class="keyword">from</span> IPython.core <span class="keyword">import</span> page</span><br><span class="line"><span class="keyword">from</span> IPython.core.alias <span class="keyword">import</span> AliasError, Alias</span><br><span class="line"><span class="keyword">from</span> IPython.core.error <span class="keyword">import</span> UsageError</span><br><span class="line"><span class="keyword">from</span> IPython.core.magic <span class="keyword">import</span>  (</span><br><span class="line">    Magics, compress_dhist, magics_class, line_magic, cell_magic, line_cell_magic</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> IPython.testing.skipdoctest <span class="keyword">import</span> skip_doctest</span><br><span class="line"><span class="keyword">from</span> IPython.utils.openpy <span class="keyword">import</span> source_to_unicode</span><br><span class="line"><span class="keyword">from</span> IPython.utils.process <span class="keyword">import</span> abbrev_cwd</span><br><span class="line"><span class="keyword">from</span> IPython.utils.terminal <span class="keyword">import</span> set_term_title</span><br><span class="line"><span class="keyword">from</span> traitlets <span class="keyword">import</span> Bool</span><br><span class="line"><span class="keyword">from</span> warnings <span class="keyword">import</span> warn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> IPython.core.magic <span class="keyword">import</span> (</span><br><span class="line">    cell_magic,</span><br><span class="line">    Magics,</span><br><span class="line">    magics_class</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@magics_class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mysqlmagics</span>(<span class="params">Magics</span>):</span></span><br><span class="line"></span><br><span class="line">    cd_force_quiet = Bool(<span class="literal">False</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;Force %cd magic to be quiet even if -q is not passed.&quot;</span></span><br><span class="line">    ).tag(config=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, shell=<span class="literal">None</span>, **kwargs</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Now define isexec in a cross platform manner.</span></span><br><span class="line">        self.is_posix = <span class="literal">False</span></span><br><span class="line">        self.execre = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> os.name == <span class="string">&#x27;posix&#x27;</span>:</span><br><span class="line">            self.is_posix = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                winext = os.environ[<span class="string">&#x27;pathext&#x27;</span>].replace(<span class="string">&#x27;;&#x27;</span>,<span class="string">&#x27;|&#x27;</span>).replace(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> KeyError:</span><br><span class="line">                winext = <span class="string">&#x27;exe|com|bat|py&#x27;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.execre = re.<span class="built_in">compile</span>(<span class="string">r&#x27;(.*)\.(%s)$&#x27;</span> % winext,re.IGNORECASE)</span><br><span class="line">            <span class="keyword">except</span> re.error:</span><br><span class="line">                warn(<span class="string">&quot;Seems like your pathext environmental &quot;</span></span><br><span class="line">                     <span class="string">&quot;variable is malformed. Please check it to &quot;</span></span><br><span class="line">                     <span class="string">&quot;enable a proper handle of file extensions &quot;</span></span><br><span class="line">                     <span class="string">&quot;managed for your system&quot;</span>)</span><br><span class="line">                winext = <span class="string">&#x27;exe|com|bat|py&#x27;</span></span><br><span class="line">                self.execre = re.<span class="built_in">compile</span>(<span class="string">r&#x27;(.*)\.(%s)$&#x27;</span> % winext,re.IGNORECASE)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># call up the chain</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(shell=shell, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义默认连接参数</span></span><br><span class="line">    pg_default = &#123;</span><br><span class="line">        <span class="string">&#x27;database&#x27;</span>: <span class="string">&#x27;actuator&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;host&#x27;</span>: <span class="string">&#x27;192.168.144.250&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;port&#x27;</span>: <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;1qaz@WSX&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;charset&#x27;</span>:<span class="string">&#x27;utf8&#x27;</span></span><br><span class="line"><span class="comment"># host: 这个是ip地址，因为我这里是本地的，所以填127.0.0.1，也可以填localhost。</span></span><br><span class="line"><span class="comment"># user：用户名，如果你也是本地的，就填root好了</span></span><br><span class="line"><span class="comment"># passwd：这个是密码</span></span><br><span class="line"><span class="comment"># db：这个是数据库名</span></span><br><span class="line"><span class="comment"># port：这个是端口，本地的一般都是3306</span></span><br><span class="line"><span class="comment"># charset：这个是编码方式，要和你数据库的编码方式一致，要不会连接失败</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 返回greenplum连接对象</span></span><br><span class="line">        <span class="comment"># pymysql.connect(host=&#x27;192.168.144.250&#x27;,user=&#x27;root&#x27;,password=&#x27;1qaz@WSX&#x27;,database=&#x27;actuator&#x27;,charset=&#x27;utf8&#x27;)</span></span><br><span class="line">        <span class="keyword">return</span> pymysql.connect(</span><br><span class="line">            database=self.pg_default[<span class="string">&#x27;database&#x27;</span>],</span><br><span class="line">            host=self.pg_default[<span class="string">&#x27;host&#x27;</span>],</span><br><span class="line">            port=<span class="built_in">int</span>(self.pg_default[<span class="string">&#x27;port&#x27;</span>]),</span><br><span class="line">            user=self.pg_default[<span class="string">&#x27;user&#x27;</span>],</span><br><span class="line">            password=self.pg_default[<span class="string">&#x27;password&#x27;</span>],</span><br><span class="line">            charset=self.pg_default[<span class="string">&#x27;charset&#x27;</span>]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment">#使用 cell_magic 修饰greenplum方法, 还可以用 line_magic或者line_cell_magic</span></span><br><span class="line"><span class="meta">    @cell_magic</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mysqlmagic2</span>(<span class="params">self, line=<span class="string">&#x27;&#x27;</span>, cell=<span class="literal">None</span></span>):</span></span><br><span class="line">        sql = cell</span><br><span class="line">        k = self.connect()</span><br><span class="line">        kursor = k.cursor()</span><br><span class="line">        kursor.execute(sql)</span><br><span class="line">        <span class="comment"># 将返回数据放入 pandas, 这样在jupyter页面返回时会更美观一些</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pd.set_option(<span class="string">&#x27;display.max_columns&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">            pd.set_option(<span class="string">&#x27;display.max_rows&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">            results = kursor.fetchall()</span><br><span class="line">            <span class="keyword">return</span> pd.DataFrame(results)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> pd.DataFrame([])</span><br></pre></td></tr></table></figure>

<h3 id="部署步骤"><a href="#部署步骤" class="headerlink" title="部署步骤"></a>部署步骤</h3><ul>
<li>首先，在服务器用源码部署</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ipython的源码下载页面为：https://pypi.python.org/pypi/ipython</span><br><span class="line"></span><br><span class="line">或者是到git页面下载：https://github.com/ipython/ipython/downloads</span><br><span class="line">假设我们下载的文件名为：ipython-7.25.0.tar.gz</span><br><span class="line">#tar zvxf ipython-7.25.0.tar.gz   //解压文件</span><br><span class="line">#cd ipython-7.25.0  //进入刚刚解压的文件夹内</span><br><span class="line"></span><br><span class="line">进入文件加后会看到一个setup.py的安装脚本，运行以下命令进行安装</span><br><span class="line">#python setup.py  install</span><br></pre></td></tr></table></figure>
<ul>
<li>再修改：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- 1.在/opt/jupyter/lib/python3.8/site-packages/IPython/core/magics目录下添加自己的magic</span><br><span class="line">- 2.修改同目录下__init__.py：添加一行“from .mysqlmagic2 import Mysqlmagics”</span><br><span class="line">- 3.修改/opt/ipython-7.25.0/IPython/core目录下interactiveshell.py，大约在2280行上下，添加m.Mysqlmagics,</span><br><span class="line">        self.register_magics(m.AutoMagics, m.BasicMagics, m.CodeMagics,</span><br><span class="line">            m.ConfigMagics, m.DisplayMagics, m.ExecutionMagics,</span><br><span class="line">            m.ExtensionMagics, m.HistoryMagics, m.LoggingMagics,</span><br><span class="line">            m.NamespaceMagics, m.OSMagics, m.PackagingMagics,</span><br><span class="line">            m.PylabMagics, m.ScriptMagics,m.Mysqlmagics,</span><br><span class="line">        )</span><br><span class="line">- 4.ipython：进入ipython源码位置，重新编译：#python setup.py  install</span><br><span class="line">- 5.重启jupyter</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://onos.love/2022/02/21/%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E9%83%A8%E7%BD%B2JuputerHub/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xuy">
      <meta itemprop="description" content="记录工作内容,分享技术经验">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经技术">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/21/%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E9%83%A8%E7%BD%B2JuputerHub/" class="post-title-link" itemprop="url">源码编译部署JuputerHub</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-02-21 14:02:00 / 修改时间：14:20:26" itemprop="dateCreated datePublished" datetime="2022-02-21T14:02:00+08:00">2022-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BD%AF%E4%BB%B6%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">软件部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JuputerHub使用源码编译部署"><a href="#JuputerHub使用源码编译部署" class="headerlink" title="JuputerHub使用源码编译部署"></a>JuputerHub使用源码编译部署</h1><h2 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h2><ul>
<li>JuputerHub部署依赖JuputerLab和Notebook</li>
<li>JuputerHub运行时需要web容器，因此需要安装node</li>
</ul>
<h2 id="python环境安装"><a href="#python环境安装" class="headerlink" title="python环境安装"></a>python环境安装</h2><h2 id="node环境"><a href="#node环境" class="headerlink" title="node环境"></a>node环境</h2><ul>
<li>官网：<a target="_blank" rel="noopener" href="https://nodejs.org/en/download/">https://nodejs.org/en/download/</a></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd /usr/local</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载</span></span><br><span class="line">wget https://nodejs.org/dist/v16.4.2/node-v16.4.2-linux-x64.tar.xz</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压</span></span><br><span class="line">tar xvf node-v16.4.2-linux-x64.tar.xz</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 建立软连接</span></span><br><span class="line">ln -s /usr/local/node-v16.4.2-linux-x64/bin/node /usr/local/bin/node</span><br><span class="line">ln -s /usr/local/node-v16.4.2-linux-x64/bin/npm /usr/local/bin/npm</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看版本</span></span><br><span class="line">node -v</span><br><span class="line">npm -v</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置npm国内源</span></span><br><span class="line">npm config set registry https://registry.npm.taobao.org/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查是否更新成功</span></span><br><span class="line">npm config get registry</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="创建python环境"><a href="#创建python环境" class="headerlink" title="创建python环境"></a>创建python环境</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd /usr/local</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建环境</span></span><br><span class="line">python3 -m venv jupyter</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入环境</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行命令后shell会出现这样的显示 (jupiter) [root@node01 ~]<span class="comment">#</span></span></span><br><span class="line">source jupyter/bin/activate</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="使用源安装部署"><a href="#使用源安装部署" class="headerlink" title="使用源安装部署"></a>使用源安装部署</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装JuputerHub</span></span><br><span class="line">pip install jupyterhub==1.4.1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查安装的包</span></span><br><span class="line">pip list | grep jupyter</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到这两个包</span></span><br><span class="line">&lt;!-- jupyter-telemetry  0.1.0 --&gt;</span><br><span class="line">&lt;!-- jupyterhub         1.4.1 --&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此时jupyterhub还不能运行，还需要继续安装JuputerLab或者notebook</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装JuputerLab</span></span><br><span class="line">pip install jupyterlab==3.0.14</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看一下安装情况可以看到一下内容</span></span><br><span class="line">pip list | grep jupyter</span><br><span class="line"></span><br><span class="line">&lt;!-- jupyter-client      6.2.0 --&gt;</span><br><span class="line">&lt;!-- jupyter-core        4.7.1 --&gt;</span><br><span class="line">&lt;!-- jupyter-server      1.9.0 --&gt;</span><br><span class="line">&lt;!-- jupyter-telemetry   0.1.0 --&gt;</span><br><span class="line">&lt;!-- jupyterhub          1.4.1 --&gt;</span><br><span class="line">&lt;!-- jupyterlab          3.0.16 --&gt;</span><br><span class="line">&lt;!-- jupyterlab-pygments 0.1.2 --&gt;</span><br><span class="line">&lt;!-- jupyterlab-server   2.6.0 --&gt;</span><br><span class="line"></span><br><span class="line">pip list | grep notebook</span><br><span class="line"></span><br><span class="line">&lt;!-- notebook            6.4.0 --&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用npm安装web代理程序</span></span><br><span class="line">npm install -g configurable-http-proxy</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="使用源码安装部署"><a href="#使用源码安装部署" class="headerlink" title="使用源码安装部署"></a>使用源码安装部署</h2><ul>
<li>下载源码: <a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub">https://github.com/jupyterhub/jupyterhub</a></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> JuputerHub安装部署</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> build JuputerHub</span></span><br><span class="line">python setup.py build</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装 JuputerHub</span></span><br><span class="line">pip install .</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> notebook安装部署（可选）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果需要使用源码安装notebook，需要在JuputerLab安装之前安装notebook</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> build notebook</span></span><br><span class="line">python setup.py build</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装 notebook</span></span><br><span class="line">pip install .</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> JuputerLab安装部署</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> build JuputerLab</span></span><br><span class="line">python setup.py build</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装 JuputerLab</span></span><br><span class="line">pip install .</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动jupyterhub，即可看到系统启动</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 然后访问即可</span></span><br><span class="line">jupyterhub </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置jupyterhub</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成配置文件</span></span><br><span class="line">mkdir /etc/jupyterhub/</span><br><span class="line">cd /etc/jupyterhub/</span><br><span class="line">jupyterhub --generate-config</span><br><span class="line"></span><br><span class="line">生成的配置文件是 jupyterhub_config.py </span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改配置文件</span></span><br><span class="line">c.JupyterHub.ip = &#x27;192.168.144.46&#x27;</span><br><span class="line">c.JupyterHub.port = 8000</span><br><span class="line">c.JupyterHub.hub_port = 8088</span><br><span class="line">c.PAMAuthenticator.encoding = &#x27;utf8&#x27;</span><br><span class="line">c.Authenticator.whitelist = &#123;&#x27;root&#x27;,&#x27;admin&#x27;, &#x27;lpx&#x27;, &#x27;xuyang&#x27;&#125;  #默认不能使用root登录，需要修改配罿</span><br><span class="line">c.LocalAuthenticator.create_system_users = True</span><br><span class="line">c.Authenticator.admin_users = &#123;&#x27;root&#x27;, &#x27;admin&#x27;&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">c.JupyterHub.authenticator_class = <span class="string">&#x27;dummyauthenticator.DummyAuthenticator&#x27;</span></span></span><br><span class="line">c.JupyterHub.authenticator_class = &#x27;jupyterhub.adc_customer.adcauthenticator.ADCAuthenticator&#x27;</span><br><span class="line">c.JupyterHub.statsd_prefix = &#x27;jupyterhub&#x27;</span><br><span class="line">c.JupyterHub.bind_url = &#x27;http://10.63.129.11:8000/spp&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 把默认的编辑工具修改为jupyterlab</span></span><br><span class="line">c.Spanwner.default_url=&#x27;/lab&#x27;</span><br><span class="line">c.Spawner.ip = &#x27;127.0.0.1&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许任何客户端访问</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">nohup jupyterhub -f /etc/jupyterhub/jupyterhub_config.py &gt; jupyterhub.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置为系统服务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建服务文件</span></span><br><span class="line">/lib/systemd/system/jupyterhub.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 内容如下，注意修改路径</span></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Jupyterhub</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">ExecStart=/usr/local/jupyter/bin/jupyterhub -f /etc/jupyterhub/jupyterhub_config.py</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://onos.love/2022/02/21/HELM%E5%AE%89%E8%A3%85JupyterHub/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xuy">
      <meta itemprop="description" content="记录工作内容,分享技术经验">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经技术">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/21/HELM%E5%AE%89%E8%A3%85JupyterHub/" class="post-title-link" itemprop="url">HELM安装JupyterHub</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-02-21 13:58:10 / 修改时间：14:00:08" itemprop="dateCreated datePublished" datetime="2022-02-21T13:58:10+08:00">2022-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">容器技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/%E8%BD%AF%E4%BB%B6%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">软件部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HELM-安装"><a href="#HELM-安装" class="headerlink" title="HELM 安装"></a>HELM 安装</h1><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul>
<li>下载：在 <a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases">https://github.com/helm/helm/releases</a> 下载相应的版本</li>
<li>安装<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">tar -zxvf helm-v3.6.3-linux-amd64.tar.gz</span><br><span class="line">sudo mv helm /usr/local/bin/helm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看版本</span></span><br><span class="line">helm version</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令补全</span></span><br><span class="line">echo &quot;source &lt;(helm completion bash)&quot; &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除默认源</span></span><br><span class="line">helm repo remove stable</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置国内源</span></span><br><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看源</span></span><br><span class="line">helm repo list</span><br><span class="line"><span class="meta">#</span><span class="bash"> NAME    URL</span>                                                   </span><br><span class="line"><span class="meta">#</span><span class="bash"> stable  https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查找测试</span></span><br><span class="line">helm search repo mysql</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h2><h3 id="搭建NFS"><a href="#搭建NFS" class="headerlink" title="搭建NFS"></a>搭建NFS</h3><h3 id="创建PV"><a href="#创建PV" class="headerlink" title="创建PV"></a>创建PV</h3><h4 id="手工创建PV"><a href="#手工创建PV" class="headerlink" title="手工创建PV"></a>手工创建PV</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 需要创建3个PV，其中2个要大于10Gi</span></span><br><span class="line"></span><br><span class="line">vi jupyterData.yaml</span><br><span class="line"></span><br><span class="line">写入：</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">    name: jupyter01</span><br><span class="line">    namespace: adc</span><br><span class="line">    labels:</span><br><span class="line">      type: nfs</span><br><span class="line">spec:</span><br><span class="line">    capacity:</span><br><span class="line">      storage: 5Gi</span><br><span class="line">    accessModes:</span><br><span class="line">      - ReadWriteOnce</span><br><span class="line">    persistentVolumeReclaimPolicy: Retain</span><br><span class="line">    nfs:</span><br><span class="line">      server: 192.168.144.171</span><br><span class="line">      path: /data/nfs/pv/jupyter</span><br><span class="line"></span><br><span class="line">kubectl apply -f jupyterData.yaml</span><br><span class="line"></span><br><span class="line">注意检查文件夹是否存在</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="自动创建PV"><a href="#自动创建PV" class="headerlink" title="自动创建PV"></a>自动创建PV</h4><p>在K8S中，每打开一个JupyterLab界面就会拉起一个POD，此POD需要占用一个PV，如果手动做这样的操作，那么将无法应对实际的业务需求。因此需要让K8S自动创建PV。这里使用NFS的StorageClass<br>参考资料：<a target="_blank" rel="noopener" href="https://github.com/kubernetes-retired/external-storage/blob/master/nfs-client/README.md">https://github.com/kubernetes-retired/external-storage/blob/master/nfs-client/README.md</a></p>
<p>注意：下面的操作一定不要带namespace，否则会有权限问题。</p>
<ul>
<li>创建RBAC和Dempolyment  </li>
</ul>
<p>新建配置文件 rbac-dempolyment.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">nfs-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">      <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">      <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">      <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">      <span class="attr">verbs:</span> [<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>, <span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">      <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;create&quot;</span>,<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>,<span class="string">&quot;update&quot;</span>]</span><br><span class="line">   <span class="bullet">-</span>  <span class="attr">apiGroups:</span> [<span class="string">&quot;extensions&quot;</span>]</span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;podsecuritypolicies&quot;</span>]</span><br><span class="line">      <span class="attr">resourceNames:</span> [<span class="string">&quot;nfs-provisioner&quot;</span>]</span><br><span class="line">      <span class="attr">verbs:</span> [<span class="string">&quot;use&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">#vi nfs-deployment.yaml；创建nfs-client的授权</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">   <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">   <span class="attr">strategy:</span></span><br><span class="line">     <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">   <span class="attr">selector:</span></span><br><span class="line">     <span class="attr">matchLabels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">   <span class="attr">template:</span></span><br><span class="line">      <span class="attr">metadata:</span></span><br><span class="line">         <span class="attr">labels:</span></span><br><span class="line">            <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">         <span class="attr">serviceAccount:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">         <span class="attr">containers:</span></span><br><span class="line">            <span class="bullet">-</span>  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">               <span class="attr">image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line">               <span class="attr">volumeMounts:</span></span><br><span class="line">                 <span class="bullet">-</span>  <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">                    <span class="attr">mountPath:</span>  <span class="string">/persistentvolumes</span></span><br><span class="line">               <span class="attr">env:</span></span><br><span class="line">                 <span class="bullet">-</span>  <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span> <span class="comment">#供应者的名字</span></span><br><span class="line">                    <span class="attr">value:</span> <span class="string">storage.pri/nfs</span> <span class="comment">#名字虽然可以随便起，以后引用要一致</span></span><br><span class="line">                 <span class="bullet">-</span>  <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">                    <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.144</span><span class="number">.171</span>  <span class="comment"># NFS服务器地址</span></span><br><span class="line">                 <span class="bullet">-</span>  <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">                    <span class="attr">value:</span> <span class="string">/data/nfs</span>        <span class="comment"># NFS文件夹地址，可以showmount -e 192.168.144.171 查看</span></span><br><span class="line">         <span class="attr">volumes:</span></span><br><span class="line">           <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">             <span class="attr">nfs:</span></span><br><span class="line">               <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.144</span><span class="number">.171</span></span><br><span class="line">               <span class="attr">path:</span> <span class="string">/data/nfs</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>创建storageClass  </li>
</ul>
<p>创建storageClass.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">storage-nfs</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">     <span class="attr">storageclass.kubernetes.io/is-default-class:</span> <span class="string">&quot;true&quot;</span>  <span class="comment"># 这一行的意思是设置为默认，可以不在这里写，后面再修改</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">storage.pri/nfs</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">True</span>  <span class="comment">#允许pvc创建后扩容</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 注意文件顺序，注意一定不要写namespace</span></span><br><span class="line">kubectl apply -f rbac-dempolyment.yaml -f storageClass.yaml </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入pod检查</span></span><br><span class="line">kubectl get pod</span><br><span class="line">kubectl logs -f nfs-client-provisioner-798699b785-4sqdw</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果报错：unexpected error getting claim reference: selfLink was empty, can<span class="string">&#x27;t make reference；</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> 原因：kubernetes 1.20版本 禁用了 selfLink；</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> 修改 /etc/kubernetes/manifests/kube-apiserver.yaml</span></span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - command:</span><br><span class="line">    - kube-apiserver</span><br><span class="line"></span><br><span class="line">修改：- --feature-gates=RemoveSelfLink=false</span><br><span class="line"></span><br><span class="line">稍等一会儿，apiServer会自动重置</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> 测试</span></span></span><br><span class="line">vi test.yaml</span><br><span class="line"></span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: test-claim</span><br><span class="line">  annotations:</span><br><span class="line">    volume.beta.kubernetes.io/storage-class: &quot;managed-nfs-storage&quot;</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Mi</span><br><span class="line"></span><br><span class="line">kubectl apply -f test.yaml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> 查看PV是否自动创建成功</span></span></span><br><span class="line">kubectl get pv,pvc </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> 把storageClass设置为默认</span></span></span><br><span class="line"></span><br><span class="line">kubectl patch storageclass storage-nfs -p &#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span><br><span class="line"></span><br><span class="line">注意storageclass的名字为刚才创建的storageclass名字，也可以在创建的时候，直接把它设置为默认。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="安装JupyterHub"><a href="#安装JupyterHub" class="headerlink" title="安装JupyterHub"></a>安装JupyterHub</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装命令</span></span><br><span class="line">helm upgrade --cleanup-on-fail --install adcjupyterhub jupyterhub/jupyterhub --version=1.0.1 --namespace adc --create-namespace --values config.yaml</span><br><span class="line"></span><br><span class="line">Release &quot;adcjupyterhub&quot; does not exist. Installing it now.</span><br><span class="line">NAME: adcjupyterhub</span><br><span class="line">LAST DEPLOYED: Thu Jul 22 16:50:30 2021</span><br><span class="line">NAMESPACE: adc</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">Thank you for installing JupyterHub!</span><br><span class="line"></span><br><span class="line">Your release is named &quot;adcjupyterhub&quot; and installed into the namespace &quot;adc&quot;.</span><br><span class="line"></span><br><span class="line">You can check whether the hub and proxy are ready by running:</span><br><span class="line"></span><br><span class="line"> kubectl --namespace=adc get pod</span><br><span class="line"></span><br><span class="line">and watching for both those pods to be in status &#x27;Running&#x27;.</span><br><span class="line"></span><br><span class="line">You can find the public (load-balancer) IP of JupyterHub by running:</span><br><span class="line"></span><br><span class="line">  kubectl -n adc get svc proxy-public -o jsonpath=&#x27;&#123;.status.loadBalancer.ingress[].ip&#125;&#x27;</span><br><span class="line"></span><br><span class="line">It might take a few minutes for it to appear!</span><br><span class="line"></span><br><span class="line">To get full information about the JupyterHub proxy service run:</span><br><span class="line"></span><br><span class="line">  kubectl --namespace=adc get svc proxy-public</span><br><span class="line"></span><br><span class="line">If you have questions, please:</span><br><span class="line"></span><br><span class="line">  1. Read the guide at https://z2jh.jupyter.org</span><br><span class="line">  2. Ask for help or chat to us on https://discourse.jupyter.org/</span><br><span class="line">  3. If you find a bug please report it at https://github.com/jupyterhub/zero-to-jupyterhub-k8s/issues</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 按照提示做后续的步骤</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改服务的访问方式为Nodeport</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="安装Ingress"><a href="#安装Ingress" class="headerlink" title="安装Ingress"></a>安装Ingress</h2><h3 id="安装Ingress-1"><a href="#安装Ingress-1" class="headerlink" title="安装Ingress"></a>安装Ingress</h3><h3 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a>创建映射</h3><h3 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h3><h2 id="使用JupyterHub"><a href="#使用JupyterHub" class="headerlink" title="使用JupyterHub"></a>使用JupyterHub</h2><p>登录后，随意输入用户名即可登录</p>
<h2 id="把JupyterHub与算法平台整合"><a href="#把JupyterHub与算法平台整合" class="headerlink" title="把JupyterHub与算法平台整合"></a>把JupyterHub与算法平台整合</h2><ul>
<li>删除之前装好的JupyterHub</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看helm安装的记录</span></span><br><span class="line">helm list -n adc</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看pod</span></span><br><span class="line">kubectl get pod -n adc </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除JupyterHub</span></span><br><span class="line">helm delete xxx -n adc</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>构建JupyterHub镜像</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 基于jupyterhub/k8s-hub镜像构建</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编写dockerFile</span></span><br><span class="line">FROM jupyterhub/k8s-hub:1.0.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解决集成登录</span></span><br><span class="line">COPY ./adcauthenticator.py /usr/local/lib/python3.8/dist-packages/jupyterhub/</span><br><span class="line">COPY ./login.py /usr/local/lib/python3.8/dist-packages/jupyterhub/handlers/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解决关闭上一个notebook后，再进入的时候，还会自动打开上一次的notebook</span></span><br><span class="line">COPY ./pages.py /usr/local/lib/python3.8/dist-packages/jupyterhub/handlers/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解决页面自动点击启动服务</span></span><br><span class="line">COPY ./home.html /usr/local/share/jupyterhub/templates/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 打包镜像</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入dockerFile所在的目录</span></span><br><span class="line">cd xxxx</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置好镜像名称和版本号，这里写的是jupyterhub/k8s-hub-adc，版本：0.0.2</span></span><br><span class="line">sudo docker build -t jupyterhub/k8s-hub-adc:0.0.2 .</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看镜像</span></span><br><span class="line">sudo docker images</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>修改JupyterHub源码</p>
<ul>
<li><p>adcauthenticator.py：继承最基础的类，直接返回即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> gen</span><br><span class="line"><span class="keyword">from</span> jupyterhub.auth <span class="keyword">import</span> Authenticator</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ADCAuthenticator</span>(<span class="params">Authenticator</span>):</span></span><br><span class="line"><span class="meta">    @gen.coroutine</span></span><br><span class="line">    <span class="comment"># 入口参数固定写法, 啥也不做, 直接返回用户�? 即为�?这里传递的data, 就是之前在login里面定义的data[&#x27;username&#x27;]和data[&#x27;password&#x27;]</span></span><br><span class="line">    <span class="comment"># 但是由于验证已经由甲方的sso做了, 所以我们用不到password, 但是格式还是要遵守的.</span></span><br><span class="line">    <span class="comment"># 其实按照这个思路, 自己把这个方法改写成mysql, postgres, 或者文本文件做用户验证, 其实也很简单</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, handler, data</span>):</span></span><br><span class="line">        user = data[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user.strip():</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> user</span><br></pre></td></tr></table></figure></li>
<li><p>login.py ()，修改LoginHandler 的get方法，修改用户名、密码验证方法，再根据用户名获取当前作业ID，把当前作业ID当做用户名来执行后续的拉起容器操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginHandler</span>(<span class="params">BaseHandler</span>):</span></span><br><span class="line">  </span><br><span class="line">		<span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.statsd.incr(<span class="string">&#x27;login.request&#x27;</span>)</span><br><span class="line">        self.log.info(self.get_login_url())</span><br><span class="line">        user = self.current_user</span><br><span class="line">        self.log.info(user)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            <span class="comment"># set new login cookie</span></span><br><span class="line">            <span class="comment"># because single-user cookie may have been cleared or incorrect</span></span><br><span class="line">            self.set_login_cookie(user)</span><br><span class="line">            self.redirect(self.get_next_url(user), permanent=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 以下是二次开发的login get</span></span><br><span class="line">            <span class="keyword">import</span> json</span><br><span class="line">            <span class="keyword">import</span> requests</span><br><span class="line">            access_token = self.get_cookie(<span class="string">&#x27;Admin-Token-SPP1&#x27;</span>)+self.get_cookie(<span class="string">&#x27;Admin-Token-SPP2&#x27;</span>)</span><br><span class="line">           </span><br><span class="line">            <span class="keyword">if</span> access_token <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                self.redirect(<span class="string">&#x27;http://192.168.144.63:8090/&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> access_token != <span class="string">&#x27;&#x27;</span>:        </span><br><span class="line">                userinfo_url = <span class="string">&#x27;http://192.168.144.63:8090/admin/user/info&#x27;</span></span><br><span class="line">                headers = &#123;</span><br><span class="line">                    <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;Bearer&#x27;</span> + <span class="string">&#x27; &#x27;</span> + access_token</span><br><span class="line">                &#125;</span><br><span class="line">                body = &#123;</span><br><span class="line">                    <span class="string">&#x27;token&#x27;</span>: access_token</span><br><span class="line">                &#125;</span><br><span class="line">                resp = json.loads(requests.get(userinfo_url, headers=headers, data=body,verify=<span class="literal">False</span>).text)</span><br><span class="line">                self.log.info(resp)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 获取jobname</span></span><br><span class="line">                jobname_url = <span class="string">&#x27;http://192.168.144.63:18094/log/jobLog/new?createName=&#x27;</span>+resp[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;username&#x27;</span>]+<span class="string">&#x27;&amp;des=%E6%89%93%E5%BC%80notebook%E6%8B%B7%E8%B4%9D%E4%BD%9C%E4%B8%9A&#x27;</span></span><br><span class="line">                resp2 = json.loads(requests.get(jobname_url, verify=<span class="literal">False</span>).text)</span><br><span class="line">                self.log.info(resp2)</span><br><span class="line">                jobname = resp2[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;jobName&#x27;</span>]</span><br><span class="line">                self.log.info(jobname)</span><br><span class="line"></span><br><span class="line">                user = jobname</span><br><span class="line">                self.log.info(user)</span><br><span class="line">                data = <span class="built_in">dict</span>()</span><br><span class="line">                data[<span class="string">&#x27;username&#x27;</span>] = user</span><br><span class="line">                data[<span class="string">&#x27;password&#x27;</span>] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                user = <span class="keyword">await</span> self.login_user(data)</span><br><span class="line">                self.log.info(<span class="string">&quot;下一个地址:%s&quot;</span>,user)</span><br><span class="line">                self.set_cookie(<span class="string">&#x27;username&#x27;</span>, jobname)</span><br><span class="line">                self.set_login_cookie(user)</span><br><span class="line">                <span class="comment">#self.redirect(self.get_next_url(user))</span></span><br><span class="line">                self.log.info(<span class="string">&quot;下一个地址:&quot;</span>,self.get_next_url(user))</span><br><span class="line">                self.log.info(<span class="string">&quot;home地址:&quot;</span>,url_path_join(self.hub.base_url, <span class="string">&#x27;home&#x27;</span>))</span><br><span class="line">                self.redirect(url_path_join(self.hub.base_url, <span class="string">&#x27;home&#x27;</span>))</span><br></pre></td></tr></table></figure></li>
<li><p>pages.py：在进入hub的时候，把之前所有的用户登录信息清空，在后面的判断中，把user换成</p>
<p>elif self.current_user</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RootHandler</span>(<span class="params">BaseHandler</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Render the Hub root page.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If next argument is passed by single-user server,</span></span><br><span class="line"><span class="string">    redirect to base_url + single-user page.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If logged in, redirects to:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - single-user server if settings.redirect_to_server (default)</span></span><br><span class="line"><span class="string">    - hub home, otherwise</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Otherwise, renders login page.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        user = self.current_user</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 增加</span></span><br><span class="line">        self.log.info(<span class="string">&quot;User logged out: %s&quot;</span>, user)</span><br><span class="line">        self.clear_login_cookie()</span><br><span class="line">        self.statsd.incr(<span class="string">&#x27;logout&#x27;</span>)</span><br><span class="line">        <span class="comment"># 重置当前用户</span></span><br><span class="line">        self._jupyterhub_user = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 结束</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.default_url:</span><br><span class="line">            <span class="comment"># As set in jupyterhub_config.py</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">callable</span>(self.default_url):</span><br><span class="line">                url = self.default_url(self)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                url = self.default_url</span><br><span class="line">        <span class="keyword">elif</span> self.current_user:</span><br><span class="line">            self.log.info(<span class="string">&quot;no login: %s&quot;</span>, user)</span><br><span class="line">            url = self.get_next_url(user)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.log.info(<span class="string">&quot;login: %s&quot;</span>, user)</span><br><span class="line">            url = url_concat(self.settings[<span class="string">&quot;login_url&quot;</span>], <span class="built_in">dict</span>(<span class="built_in">next</span>=self.request.uri))</span><br><span class="line">        self.redirect(url)</span><br></pre></td></tr></table></figure></li>
<li><p>home.html：增加自动点击按钮的操作。这里并不是最优的方式，可以在后台的python代码中修改跳转逻辑</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block script %&#125;</span><br><span class="line">&#123;&#123; super() &#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="built_in">require</span>([<span class="string">&quot;home&quot;</span>]);</span></span><br><span class="line"><span class="javascript"> <span class="built_in">window</span>.onload = f2;</span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="keyword">function</span> <span class="title">f2</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.getElementById(<span class="string">&quot;start&quot;</span>).click();</span></span><br><span class="line"><span class="javascript">       </span></span><br><span class="line"><span class="javascript">  &#125;</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>修改Helm安装JuypterHub的配置文件，详细的配置说明参考官网：<a target="_blank" rel="noopener" href="https://zero-to-jupyterhub.readthedocs.io/en/latest/resources/reference.html">https://zero-to-jupyterhub.readthedocs.io/en/latest/resources/reference.html</a></p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改配置文件中的默认路径、打开编辑器为lab；修改hub的镜像</span></span><br><span class="line"></span><br><span class="line">singleuser:</span><br><span class="line">  extraEnv:</span><br><span class="line">    EDITOR: &quot;vim&quot;</span><br><span class="line">  defaultUrl: &quot;/lab&quot;</span><br><span class="line">  image:</span><br><span class="line">    name: jupyterhub/k8s-singleuser-sample-adc</span><br><span class="line">    tag: 0.0.3</span><br><span class="line">hub:</span><br><span class="line">  image:</span><br><span class="line">    name: jupyterhub/k8s-hub-adc</span><br><span class="line">    tag: 0.0.18-Alpha</span><br><span class="line">  baseUrl: &quot;/spp&quot;</span><br><span class="line">  config:</span><br><span class="line">    JupyterHub:</span><br><span class="line">      authenticator_class: &#x27;jupyterhub.adcauthenticator.ADCAuthenticator&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行安装命令</span></span><br><span class="line">helm upgrade --cleanup-on-fail --install adcjupyterhub jupyterhub/jupyterhub --namespace adc --create-namespace --values config.yaml</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>构建SimpleUer镜像</p>
<ul>
<li>修改界面</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 两种构建方式：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1，dockerfile,如果镜像内版本与源码版本一致（3.1.0rc1）</span></span><br><span class="line">FROM jupyterhub/k8s-singleuser-sample:1.0.1</span><br><span class="line">ADD ./lab.tar /opt/conda/share/jupyter/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2，dockerfile,如果镜像内版本与源码版本不一致（代码为3.1.0rc1）</span></span><br><span class="line">FROM jupyterhub/k8s-singleuser-sample:1.0.1</span><br><span class="line">RUN pip uninstall jupyterlab -y</span><br><span class="line">ADD jupyterlab-3.1.0rc1-py3-none-any.whl /home/jovyan/</span><br><span class="line">RUN pip install /home/jovyan/jupyterlab-3.1.0rc1-py3-none-any.whl</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 打包镜像</span></span><br><span class="line">sudo docker build -t jupyterhub/k8s-singleuser-sample-adc:0.0.2 .</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>增加依赖</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> DockerFile</span></span><br><span class="line"></span><br><span class="line">FROM jupyterhub/k8s-singleuser-sample-adc:0.0.2</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装环境依赖</span></span><br><span class="line">COPY requirements.txt /tmp/requirements.txt</span><br><span class="line">RUN python -m pip install --no-cache-dir \</span><br><span class="line">    -r /tmp/requirements.txt \</span><br><span class="line">    -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 打包镜像</span></span><br><span class="line">sudo docker build -t jupyterhub/k8s-singleuser-sample-adc:0.0.2.1 .</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>增加magic：<br>增加Magic有3种方法，由于Single-User镜像第一次启动的时候ipython工作目录是为空的，即便是在镜像制作的时候提前建文件夹也不行。因此只能通过修改ipython源码的方式把自定义magic内置进去。<br>1，在IPython/core/magics 目录下新建 mysqlmagic.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> IPython.core.magic <span class="keyword">import</span> (</span><br><span class="line">    cell_magic,</span><br><span class="line">    Magics,</span><br><span class="line">    magics_class</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@magics_class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mysqlmagics</span>(<span class="params">Magics</span>):</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 定义默认连接参数</span></span><br><span class="line">    pg_default = &#123;</span><br><span class="line">        <span class="string">&#x27;database&#x27;</span>: <span class="string">&#x27;actuator&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;host&#x27;</span>: <span class="string">&#x27;192.168.144.63&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;port&#x27;</span>: <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;1qaz@WSX&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;charset&#x27;</span>:<span class="string">&#x27;utf8&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 返回greenplum连接对象</span></span><br><span class="line">        <span class="keyword">return</span> pymysql.connect(</span><br><span class="line">            database=self.pg_default[<span class="string">&#x27;database&#x27;</span>],</span><br><span class="line">            host=self.pg_default[<span class="string">&#x27;host&#x27;</span>],</span><br><span class="line">            port=<span class="built_in">int</span>(self.pg_default[<span class="string">&#x27;port&#x27;</span>]),</span><br><span class="line">            user=self.pg_default[<span class="string">&#x27;user&#x27;</span>],</span><br><span class="line">            password=self.pg_default[<span class="string">&#x27;password&#x27;</span>],</span><br><span class="line">            charset=self.pg_default[<span class="string">&#x27;charset&#x27;</span>]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment">#使用 cell_magic 修饰greenplum方法, 还可以用 line_magic或者line_cell_magic</span></span><br><span class="line"><span class="meta">    @cell_magic</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mysqlmagic</span>(<span class="params">self, line=<span class="string">&#x27;&#x27;</span>, cell=<span class="literal">None</span></span>):</span></span><br><span class="line">        sql = cell</span><br><span class="line">        k = self.connect()</span><br><span class="line">        kursor = k.cursor()</span><br><span class="line">        kursor.execute(sql)</span><br><span class="line">        <span class="comment"># 将返回数据放入 pandas, 这样在jupyter页面返回时会更美观一些</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pd.set_option(<span class="string">&#x27;display.max_columns&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">            pd.set_option(<span class="string">&#x27;display.max_rows&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">            results = kursor.fetchall()</span><br><span class="line">            <span class="keyword">return</span> pd.DataFrame(results)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> pd.DataFrame([])</span><br></pre></td></tr></table></figure>

<p>2，IPython/core/magics 目录下 <strong>init</strong>.py：添加一行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .mysqlmagic2 <span class="keyword">import</span> Mysqlmagics</span><br></pre></td></tr></table></figure>

<p>3，IPython/core目录下interactiveshell.py，大约在2280行上下，添加m.Mysqlmagics,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">self.register_magics(m.AutoMagics, m.BasicMagics, m.CodeMagics,</span><br><span class="line">    m.ConfigMagics, m.DisplayMagics, m.ExecutionMagics,</span><br><span class="line">    m.ExtensionMagics, m.HistoryMagics, m.LoggingMagics,</span><br><span class="line">    m.NamespaceMagics, m.OSMagics, m.PackagingMagics,</span><br><span class="line">    m.PylabMagics, m.ScriptMagics,m.Mysqlmagics,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>编写测试magic如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> DockerFile</span></span><br><span class="line"></span><br><span class="line">FROM jupyterhub/k8s-singleuser-sample-adc:0.0.2.1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装内置magic的iPython</span></span><br><span class="line">COPY ipython-7.27.0.tar.gz /tmp</span><br><span class="line">RUN cd /tmp \</span><br><span class="line">    &amp;&amp; tar -zxvf ipython-7.27.0.tar.gz \</span><br><span class="line">    &amp;&amp; cd /tmp/ipython-7.27.0 \</span><br><span class="line">    &amp;&amp; python setup.py install</span><br><span class="line"></span><br><span class="line">  - JupyterHub 配置文件</span><br></pre></td></tr></table></figure>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1></li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">singleuser:</span></span><br><span class="line">  <span class="attr">defaultUrl:</span> <span class="string">&quot;/lab&quot;</span></span><br><span class="line">  <span class="attr">image:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jupyterhub/k8s-singleuser-sample-adc</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="number">0.0</span><span class="number">.3</span></span><br><span class="line"><span class="attr">hub:</span></span><br><span class="line">  <span class="attr">image:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jupyterhub/k8s-hub-adc</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="number">0.0</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">baseUrl:</span> <span class="string">&quot;/spp&quot;</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">JupyterHub:</span></span><br><span class="line">      <span class="attr">authenticator_class:</span> <span class="string">&#x27;jupyterhub.adcauthenticator.ADCAuthenticator&#x27;</span></span><br><span class="line">      <span class="attr">admin_access:</span> <span class="literal">True</span></span><br><span class="line">      <span class="attr">admin_users:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">admin</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">xuyang</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="打包镜像"><a href="#打包镜像" class="headerlink" title="打包镜像"></a>打包镜像</h1><p>sudo docker build -t jupyterhub/k8s-singleuser-sample-adc:0.0.3 .</p>
<ul>
<li>修改API网关</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改路由</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">jupyterlab</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">http://192.168.144.63:8000</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/jupyter/**</span></span><br><span class="line">  <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">RewritePath=/jupyter(?&lt;segment&gt;/?.*),</span> <span class="string">/spp$\&#123;segment&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>修改Nginx</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 修改Nginx的配置信息</span></span><br><span class="line"></span><br><span class="line">map $http_upgrade $connection_upgrade &#123;</span><br><span class="line"> default upgrade;</span><br><span class="line"> &#x27;&#x27; close;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       8090;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    root         /root/spp/dist;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">		proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line"> 		proxy_set_header Host $host:$server_port;</span><br><span class="line">		proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        proxy_intercept_errors off;</span><br><span class="line"></span><br><span class="line">         # 动态页面 后端端口号</span><br><span class="line">        if ( !-e $request_filename) &#123;</span><br><span class="line">            proxy_pass   http://192.168.144.63:18888;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   </span><br><span class="line">   location ~* /spp/(api/kernels/[^/]+/(channels|iopub|shell|stdin)|terminals/websocket|hub|user)/ &#123; </span><br><span class="line">    # JupyterHub的访问地址</span><br><span class="line">    proxy_pass http://192.168.144.171:31075; </span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header Host $host:$server_port;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">    # websocket support </span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">    proxy_set_header Connection $connection_upgrade;</span><br><span class="line">    proxy_read_timeout 86400; </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="检查问题"><a href="#检查问题" class="headerlink" title="检查问题"></a>检查问题</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 新建文件</span></span><br><span class="line"></span><br><span class="line">vi busybox.yaml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意镜像版本不能大于1.28.4，有bug，会出现以下提示</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Server:         10.96.0.10</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Address:        10.96.0.10:53</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ** server can<span class="string">&#x27;t find kubernetes.default: NXDOMAIN</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> *** Can&#x27;</span>t find kubernetes.default: No answer</span></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: adc</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: busybox:1.28.4</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - &quot;3600&quot;</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: busybox</span><br><span class="line">  restartPolicy: Always</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl  apply -f busybox.yaml</span><br><span class="line"></span><br><span class="line">kubectl get pods busybox -n adc</span><br><span class="line"></span><br><span class="line">kubectl exec -ti busybox -n adc -- nslookup kubernetes.default</span><br><span class="line"></span><br><span class="line">kubectl edit eployment coredns -n kube-system</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重做coreDNS</span></span><br><span class="line">kubectl delete --namespace=kube-system deployment coredns</span><br><span class="line"></span><br><span class="line">wget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/coredns.yaml.sed</span><br><span class="line">wget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/deploy.sh</span><br><span class="line">chmod +x deploy.sh</span><br><span class="line">./deploy.sh | kubectl apply -f -</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://onos.love/2022/02/21/K8S%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xuy">
      <meta itemprop="description" content="记录工作内容,分享技术经验">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经技术">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/21/K8S%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">K8S安装部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-02-21 13:52:26 / 修改时间：13:53:29" itemprop="dateCreated datePublished" datetime="2022-02-21T13:52:26+08:00">2022-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">容器技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul>
<li>CentOS系统内核升级</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 获取源：</span></span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装：（可以在后面指定版本）</span></span><br><span class="line">yum --enablerepo=elrepo-kernel install -y kernel-lt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置开机从新内核启动  kernel-lt.x86_64 0:4.4.229-1.el7.elrepo(注意此处的版本号，如果之前没有指定版本安装，此处一定要看清楚安装的版本号，然后再设置启动使用的内核版本号)</span></span><br><span class="line">grub2-set-default &#x27;CentOS Linux (4.4.230-1.el7.elrepo.x86_64) 7 (Core)&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启</span></span><br><span class="line">reboot</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前内核</span></span><br><span class="line">uname -sr</span><br><span class="line"><span class="meta">#</span><span class="bash"> 以下可以选择性操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看所有内核</span></span><br><span class="line">rpm -qa | grep kernel</span><br><span class="line"><span class="meta">#</span><span class="bash"> 移除不需要的内核</span></span><br><span class="line">yum remove xxxx</span><br></pre></td></tr></table></figure>

<ul>
<li>使用root账号创建用户</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建用户</span></span><br><span class="line">adduser adcadm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置密码</span></span><br><span class="line">passwd adcadm</span><br><span class="line"></span><br><span class="line">设置密码：Adc123456</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 增加权限</span></span><br><span class="line">chmod -v u+w /etc/sudoers</span><br><span class="line"></span><br><span class="line">vi /etc/sudoers</span><br><span class="line">增加一行，配置sudo权限，同时配置免密</span><br><span class="line">username ALL=(ALL) NOPASSWD: ALL</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>设置机器名</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在master机器上设置</span></span><br><span class="line">sudo hostnamectl set-hostname master01</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在node机器上设置</span></span><br><span class="line">sudo hostnamectl set-hostname node01</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>在所有的机器上配置hosts文件，把IP地址都配置在文件中</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;&gt; /etc/hosts</span><br><span class="line">192.168.144.171 master01</span><br><span class="line">192.168.144.170 node01</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>操作系统配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 并进入用户目录</span></span><br><span class="line">cd ~</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编写配置参数</span></span><br><span class="line">sudo bash -c &#x27;cat &gt; kubernetes.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">vm.swappiness=0 # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它</span><br><span class="line">vm.overcommit_memory=1 # 不检查物理内存是否够用</span><br><span class="line">vm.panic_on_oom=0 # 开启 OOM</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">EOF&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝到系统目录</span></span><br><span class="line">sudo cp kubernetes.conf /etc/sysctl.d/kubernetes.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生效</span></span><br><span class="line">sudo sysctl -p /etc/sysctl.d/kubernetes.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭不需要的服务,非root账号无法关闭</span></span><br><span class="line">systemctl stop postfix &amp;&amp; systemctl disable postfix</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看swap是否关闭,如果swap行显示不为0，则没有关闭</span></span><br><span class="line">free -g</span><br><span class="line"><span class="meta">#</span><span class="bash"> 暂时关闭swap</span></span><br><span class="line">sudo swapoff -a</span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用swap</span></span><br><span class="line"><span class="meta">#</span><span class="bash">1、注释/etc/fstab关于swap的配置</span></span><br><span class="line">sudo vi /etc/fstab</span><br><span class="line"><span class="meta">#</span><span class="bash"> /dev/mapper/centos-swap swap           swap   defaults   0 0</span></span><br><span class="line">sudo bash -c &#x27;echo vm.swappiness=0 &gt;&gt; /etc/sysctl.con&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启</span></span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure>

<ul>
<li>安全设置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 关闭防火墙，注意此处需要根据实际情况来决定是否关闭。</span></span><br><span class="line">sudo systemctl stop firewalld</span><br><span class="line">sudo systemctl disable firewalld</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭SeLinux</span></span><br><span class="line">setenforce 0</span><br><span class="line">sudo sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config</span><br></pre></td></tr></table></figure>

<ul>
<li>时钟检查</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看当前时间，如果时区是东8区，则不需要做其它操作</span></span><br><span class="line">date</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置系统时区为 中国/上海</span></span><br><span class="line">timedatectl set-timezone Asia/Shanghai # 将当前的 UTC 时间写入硬件时钟</span><br><span class="line">timedatectl set-local-rtc 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启依赖于系统时间的服务</span></span><br><span class="line">systemctl restart rsyslog</span><br><span class="line">systemctl restart crond</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置NTP时钟（待补充）</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>日志配置,centos有两套日志系统，为了便于后续使用，这里关闭一个</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 持久化保存日志的目录</span></span><br><span class="line">sudo mkdir /var/log/journal</span><br><span class="line">sudo mkdir /etc/systemd/journald.conf.d</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编写配置文件</span></span><br><span class="line">cd /etc/systemd/journald.conf.d</span><br><span class="line">sudo bash -c &#x27;cat &gt; 99-prophet.conf &lt;&lt;EOF</span><br><span class="line">[Journal]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 持久化保存到磁盘</span></span><br><span class="line">Storage=persistent</span><br><span class="line"><span class="meta">#</span><span class="bash"> 压缩历史日志</span></span><br><span class="line">Compress=yes</span><br><span class="line">SyncIntervalSec=5m</span><br><span class="line">RateLimitInterval=30s</span><br><span class="line">RateLimitBurst=1000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大占用空间 10G</span></span><br><span class="line">SystemMaxUse=10G</span><br><span class="line"><span class="meta">#</span><span class="bash"> 单日志文件最大 200M</span></span><br><span class="line">SystemMaxFileSize=200M</span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志保存时间 2 周</span></span><br><span class="line">MaxRetentionSec=2week</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不将日志转发到</span></span><br><span class="line">syslog ForwardToSyslog=no</span><br><span class="line">EOF&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启日志服务</span></span><br><span class="line">sudo systemctl restart systemd-journald</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>开启IPVS(–)</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 加载透明防火墙模块</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编写配置文件</span></span><br><span class="line">cd /etc/sysconfig/modules/</span><br><span class="line">sudo bash -c &#x27;cat &gt; ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br><span class="line">EOF&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 赋权并启用</span></span><br><span class="line">sudo chmod 755 /etc/sysconfig/modules/ipvs.modules </span><br><span class="line">bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>yum源配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装wget</span></span><br><span class="line">sudo yum install wget -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置源</span></span><br><span class="line">cd /etc/yum.repos.d</span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份旧的配置文件</span></span><br><span class="line">mv CentOS-Base.repo CentOS-Base.repo.bak</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载阿里源的文件</span></span><br><span class="line">wget -O CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清理缓存</span></span><br><span class="line">sudo yum clean all</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新生成缓存</span></span><br><span class="line">sudo yum makecache</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 卸载docker</span></span><br><span class="line">sudo yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装源</span>               </span><br><span class="line">sudo yum install -y yum-utils</span><br><span class="line">sudo yum-config-manager --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装docker</span></span><br><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io -y</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动服务</span></span><br><span class="line">sudo systemctl start docker</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置开机自启</span></span><br><span class="line">sudo systemctl enable docker</span><br></pre></td></tr></table></figure>



<h2 id="安装K8S"><a href="#安装K8S" class="headerlink" title="安装K8S"></a>安装K8S</h2><ul>
<li>版本<ul>
<li>kubeadm v1.21.2  </li>
<li>kubectl v1.21.2  </li>
<li>kubelet v1.21.2  </li>
<li>k8s镜像版本：v1.21.0  </li>
</ul>
</li>
<li>设置源</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 写入kubernetes的源描述文件,注意gpgkey的位置写的是国内源位置</span></span><br><span class="line">sudo bash -c &#x27;cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>在Master 和 Node上都安装K8S工具</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装工具（由于镜像文件只有1.18.2，所以工具也安装匹配的版本）</span></span><br><span class="line">sudo yum install -y kubectl-1.21.3-0 kubelet-1.21.3-0 kubeadm-1.21.3-0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动kubelet服务,此时本服务是无法正常启动的，需要初始化之后才可以正常启动</span></span><br><span class="line">sudo systemctl enable kubelet</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Master初始化集群</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在Master机器上增加命令补全功能，完成后，使用kubectl命令就可以使用tab键进行补全</span></span><br><span class="line">sudo yum install -y bash-completion</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在Master机器上生成K8S master的配置文件</span></span><br><span class="line">cd ~</span><br><span class="line">sudo kubeadm config print init-defaults &gt; init.yaml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改配置文件，必须修改的有以下3个位置</span></span><br><span class="line"></span><br><span class="line">localAPIEndpoint:</span><br><span class="line">    advertiseAddress: 192.168.144.171  # master机器的IP</span><br><span class="line"></span><br><span class="line">imageRepository: registry.aliyuncs.com/google_containers  # 下载镜像的仓库地址，这里使用阿里的地址</span><br><span class="line"></span><br><span class="line">nodeRegistration:</span><br><span class="line">    name: master01 # 这里必须配置master所在机器的机器名称，否则会在初始化的时候报警告信息</span><br><span class="line"></span><br><span class="line">kubernetesVersion  # 根据实际需要修改</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查网络情况，是否可以正常连接到registry.aliyuncs.com镜像仓库，如果网络不通，或者等待较长时间，则说明网络有问题，后面大概率也会因为超时而失败</span></span><br><span class="line">ping aliyuncs.com</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 初始化master，需要把日志记录下来，便于以后向该master继续增加node；注意如果直接初始化的时候，这里会报一个错，registry.aliyuncs.com/google_containers/coredns:v1.8.0下载不成功，原因是阿里仓库的该版本镜像版本号不正确，需要手动下载，然后修改版本号</span></span><br><span class="line">sudo docker pull registry.aliyuncs.com/google_containers/coredns:1.8.0</span><br><span class="line">sudo docker tag registry.aliyuncs.com/google_containers/coredns:1.8.0 registry.aliyuncs.com/google_containers/coredns:v1.8.0</span><br><span class="line">目前只是这个版本发现了此问题，不代表所有版本都会有这个问题，需要具体问题具体分析</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行master初始化</span></span><br><span class="line">cd ~</span><br><span class="line">sudo kubeadm init --config init.yaml | tee k8s_init.log</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 耐心等待master初始化完成，过程中需要下载大量的镜像文件；日志结尾处会标识如何join该集群</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 按照日志提示做后续操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝文件，以及允许非root账号使用kubectl命令</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此时master已经安装成功</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看集群信息,可以看到mater节点已经在集群中了，但是状态是 NotReady；等网络组件安装成功，才能Ready</span></span><br><span class="line">sudo kubectl get node</span><br><span class="line"><span class="meta">#</span><span class="bash"> NAME       STATUS     ROLES                  AGE   VERSION</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> master01   NotReady   control-plane,master   84s   v1.21.3</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看pod信息，注意后面必须带命名空间，集群管理默认的命名空间是kube-system</span></span><br><span class="line">kubectl get pods --namespace=kube-system   </span><br><span class="line"><span class="meta">#</span><span class="bash"> [adcadm@master01 ~]$ kubectl get pods --namespace=kube-system</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> NAME                               READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> coredns-59d64cd4d4-2vpk4           0/1     Pending   0          101s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> coredns-59d64cd4d4-ts88v           0/1     Pending   0          101s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> etcd-master01                      1/1     Running   0          100s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kube-apiserver-master01            1/1     Running   0          100s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kube-controller-manager-master01   1/1     Running   0          100s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kube-proxy-khj56                   1/1     Running   0          101s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kube-scheduler-master01            1/1     Running   0          100s</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装网络组件，calico网络组件功能更强，我们使用该组件;会等待一段时间下载calico镜像；</span></span><br><span class="line">kubectl apply -f https://docs.projectcalico.org/v3.14/manifests/calico.yaml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查node状态，此时master已经Ready</span></span><br><span class="line">kubectl get node</span><br><span class="line">NAME       STATUS   ROLES                  AGE     VERSION</span><br><span class="line">master01   Ready    control-plane,master   6m34s   v1.21.3</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看pod信息，calico初始化需要一段时间，具体时间根据下载镜像的速度来定</span></span><br><span class="line">kubectl get pods --namespace=kube-system</span><br><span class="line">NAME                                       READY   STATUS              RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-7676785684-sdc4t   0/1     ContainerCreating   0          14s</span><br><span class="line">calico-node-pnrrn                          0/1     Running             0          15s</span><br><span class="line">coredns-59d64cd4d4-2vpk4                   0/1     Pending             0          6m6s</span><br><span class="line">coredns-59d64cd4d4-ts88v                   0/1     Pending             0          6m6s</span><br><span class="line">etcd-master01                              1/1     Running             0          6m5s</span><br><span class="line">kube-apiserver-master01                    1/1     Running             0          6m5s</span><br><span class="line">kube-controller-manager-master01           1/1     Running             0          6m5s</span><br><span class="line">kube-proxy-khj56                           1/1     Running             0          6m6s</span><br><span class="line">kube-scheduler-master01                    1/1     Running             0          6m5s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Node 加入集群</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 把node加入到集群，使用master安装时候输出的日志最后一段即可，等待下载镜像。【注意：此处命令复制的时候一定要看有没有什么特殊字符，会导致命令运行失败】</span></span><br><span class="line">sudo kubeadm join 192.168.144.171:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">	--discovery-token-ca-cert-hash sha256:df66b3c2ac1f12965bde58a052d8bb583bf86b09e87d93219fd38da11cfa98a1 </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查node状态，等待Node完成Ready状态</span></span><br><span class="line">kubectl get node</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看pod信息</span></span><br><span class="line">kubectl get pods --namespace=kube-system </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> node加入集群需要下载几个镜像，时间视网速而定，也可能因为下载不了镜像而出现不成功。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>节点加入集群时，Token过期（没有验证）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在Master查找令牌</span></span><br><span class="line">sudo kubeadm token list</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成永久令牌</span></span><br><span class="line">sudo kubeadm token create --ttl 0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 快速生成join命令</span></span><br><span class="line">sudo kubeadm token create --print-join-command</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取discovery-token-ca-cert-hash</span></span><br><span class="line">sudo  openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform</span><br><span class="line">der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed &#x27;s/^.* //&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> join集群</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>问题检查,K8S在初始化或者加入节点的时候一旦出现异常情况，请查阅日志，如果命令执行成功，而node或者pod不正常，使用kubectl工具来查找问题</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 检查node问题</span></span><br><span class="line">kubectl describe node xxxxx</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查pod问题</span></span><br><span class="line">kubectl describe pod xxxxx --namespace=xxxx</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看集群状态</span></span><br><span class="line">kubectl cluster-info</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查组件状态,</span></span><br><span class="line">kubectl get cs</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果报出两个 unhealthy 的错误</span></span><br><span class="line">controller-manager   Unhealthy   Get &quot;http://127.0.0.1:10252/healthz&quot;: dial tcp 127.0.0.1:10252: connect: connection refused   </span><br><span class="line">scheduler            Unhealthy   Get &quot;http://127.0.0.1:10251/healthz&quot;: dial tcp 127.0.0.1:10251: connect: connection refused</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改配置文件</span></span><br><span class="line">/etc/kubernetes/mainfests/kube-controller-manager.yaml</span><br><span class="line">注释掉 - --port=0</span><br><span class="line"></span><br><span class="line">/etc/kubernetes/mainfests/kube-scheduler.yaml</span><br><span class="line">注释掉 - --port=0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启kubelet</span></span><br><span class="line">sudo systemctl restart kubelet</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查组件状态,都正常了</span></span><br><span class="line">kubectl get cs</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Node Join后显示NotReady</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查日志</span></span><br><span class="line">journalctl -f -u kubelet</span><br><span class="line">Apr 01 14:24:08 sz-pg-oam-docker-test-001.tendcloud.com kubelet[103932]: I0401 14:24:08.359839  103932 kubelet.go:1752] skipping pod synchronization - [Failed to start ContainerManager failed to initialise top level QOS containers: failed to create top level Burstable QOS cgroup : Unit kubepods-burstable.slice already exists.]</span><br><span class="line"></span><br><span class="line">此问题是系统bug，重启Node服务器即可解决</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>节点卸载</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在node上执行</span></span><br><span class="line">sudo kubeadm reset</span><br><span class="line">iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br><span class="line">ipvsadm -C</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在Master上执行</span></span><br><span class="line">kubectl delete node xxxxx</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://onos.love/2022/02/21/elk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xuy">
      <meta itemprop="description" content="记录工作内容,分享技术经验">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经技术">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/21/elk/" class="post-title-link" itemprop="url">部署ELK日志收集</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-02-21 13:03:45 / 修改时间：13:18:24" itemprop="dateCreated datePublished" datetime="2022-02-21T13:03:45+08:00">2022-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BD%AF%E4%BB%B6%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">软件部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="安装Elasticsearch"><a href="#安装Elasticsearch" class="headerlink" title="安装Elasticsearch"></a>安装Elasticsearch</h3><p>1.rpm -ivh elasticsearch-7.12.0-x86_64.rpm</p>
<p>2.修改配置文件</p>
<p>vim /etc/elasticsearch/elasticsearch.yml</p>
<p>（1）单机模式</p>
<p>​    network.host: 192.168.144.228</p>
<p>​    discovery.seed_hosts: [“192.168.144.228”]</p>
<p>​    discovery.type: single-node</p>
<p>（2）集群模式</p>
<pre><code>cluster.name: es-cluster 
node.name: node01 #每台服务器分别设置
node.master: true
node.data: true 
network.host: 192.168.11.35 #每台服务器分别设置
http.port: 9200 
discovery.zen.ping.unicast.hosts: [&quot;192.168.11.35&quot;,&quot;192.168.11.36&quot;,&quot;192.168.11.37&quot;] 
discovery.zen.minimum_master_nodes: 2  #取值为N/2 + 1
http.cors.enabled: true 
http.cors.allow-origin: &quot;*&quot;
</code></pre>
<p> 3.启动、停止、查询状态</p>
<p>systemctl start elasticsearch<br>systemctl stop elasticsearch<br>systemctl status elasticsearch</p>
<p> 4.网页访问是否启动成功</p>
<p>curl  127.0.0.1:9200</p>
<ul>
<li>安装elasticsearch-head   </li>
<li>拉取镜像<br>docker pull mobz/elasticsearch-head:5 </li>
<li>创建容器<br>docker create –name elasticsearch-head -p 9100:9100 mobz/elasticsearch-head:5 </li>
<li>启动容器<br>docker start elasticsearch-head</li>
<li>通过浏览器访问<br>ip:9100</li>
</ul>
<h3 id="安装kibana"><a href="#安装kibana" class="headerlink" title="安装kibana"></a>安装kibana</h3><p>1.安装包<br>rpm -ivh kibana-7.12.0-x86_64.rpm</p>
<p>2.修改配置文件，配置IP地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi  /etc/kibana/kibana.yml</span><br><span class="line"></span><br><span class="line">server.host:  0.0.0.0 *#对外暴露服务的地址*  </span><br><span class="line"></span><br><span class="line">elasticsearch.hosts: [&quot;http://192.168.144.101:9200&quot;]  #单机模式</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">elasticsearch.hosts: [<span class="string">&quot;http://ip1:9200&quot;</span>, <span class="string">&quot;http://ip2:9200&quot;</span>]  <span class="comment">#集群模式</span></span></span><br></pre></td></tr></table></figure>

<p>3.启动、停止、查询状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start kibana</span><br><span class="line">systemctl stop kibana</span><br><span class="line">systemctl status kibana</span><br></pre></td></tr></table></figure>

<p>4.网页访问是否启动成功</p>
<p>http:<em>//ip:5601/</em></p>
<h3 id="安装Logstash"><a href="#安装Logstash" class="headerlink" title="安装Logstash"></a>安装Logstash</h3><ol>
<li>安装包<br>rpm -ivh logstash-7.120.rpm</li>
</ol>
<p>2.修改配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">vi /etc/logstash/logstash-sample.conf</span><br><span class="line"></span><br><span class="line">input&#123;</span><br><span class="line">tcp &#123; </span><br><span class="line">mode =&gt; &quot;server&quot; </span><br><span class="line">host =&gt; &quot;0.0.0.0&quot; </span><br><span class="line">port =&gt; 4567 </span><br><span class="line">codec =&gt; json_lines </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">filter&#123;</span><br><span class="line">json&#123;</span><br><span class="line">source =&gt; &quot;message&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">output&#123;</span><br><span class="line">elasticsearch &#123;</span><br><span class="line">hosts =&gt; [&quot;192.168.144.101:9200&quot;]</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">hosts =&gt; [<span class="string">&quot;192.168.144.101:9200&quot;</span>,<span class="string">&quot;192.168.144.102:9200&quot;</span>]  <span class="comment">#集群模式</span></span></span><br><span class="line"></span><br><span class="line">index =&gt; &quot;springboot-logstash-%&#123;+YYYY.MM&#125;&quot;</span><br><span class="line">document_type =&gt; &quot;%&#123;[message_type]&#125;&quot;</span><br><span class="line">&#125; </span><br><span class="line">stdout &#123; codec =&gt; rubydebug&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.启动、停止、查询状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start logstash  #系统去/etc/logstash查找配置文件 </span><br><span class="line">systemctl stop logstash</span><br><span class="line">systemctl status logstash</span><br></pre></td></tr></table></figure>
<p>4.验证效果</p>
<p>cd /usr/share/logstash/bin<br>./logstash -e “input{stdin{}} output{stdout{}}”</p>
<p>启动完成后：输入 hello world! 可以看到结果</p>
<h2 id="权限验证"><a href="#权限验证" class="headerlink" title="权限验证"></a>权限验证</h2><h3 id="在ES节点上设置用户密码"><a href="#在ES节点上设置用户密码" class="headerlink" title="在ES节点上设置用户密码"></a>在ES节点上设置用户密码</h3><p><strong>1.生成CA证书</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/elasticsearch/bin</span><br><span class="line"></span><br><span class="line">[EsUser@localhost ~]$ ./elasticsearch-certutil  ca</span><br><span class="line"></span><br><span class="line">Please enter the desired output file [elastic-stack-ca.p12]: #这里直接回车即可</span><br><span class="line"></span><br><span class="line">Enter password for elastic-stack-ca.p12 :  #这里直接回车即可，不要设置密码</span><br><span class="line"></span><br><span class="line">设置完毕后，会在/usr/share/elasticsearch下看到新生成的文件：</span><br><span class="line"></span><br><span class="line">elastic-stack-ca.p12</span><br></pre></td></tr></table></figure>

<p><strong>2.生成p12秘钥</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">./elasticsearch-certutil cert --ca elastic-stack-ca.p12</span><br><span class="line"></span><br><span class="line">Enter password for CA (elastic-stack-ca.p12) : </span><br><span class="line"></span><br><span class="line">Please enter the desired output file [elastic-certificates.p12]:</span><br><span class="line"></span><br><span class="line">Enter password for elastic-certificates.p12 : #这里直接回车即可，不要设置密码，否则后面ES会启动不了</span><br><span class="line"></span><br><span class="line">Certificates written to /usr/share/elasticsearch/elastic-certificates.p12</span><br><span class="line"></span><br><span class="line">设置完毕后，会在/usr/share/elasticsearch/elasticsearch-7.6.2下看到新生成的文件：</span><br><span class="line"></span><br><span class="line">elastic-certificates.p12</span><br></pre></td></tr></table></figure>

<p><strong>3.拷贝证书文件到指定路径下</strong></p>
<p>cp  /usr/share/elasticsearch/elastic-certificates.p12   /etc/elasticsearch/</p>
<p><strong>4.将p12认证文件拷贝到其他节点上</strong></p>
<p>位置  /etc/elasticsearch/</p>
<p><strong>5.修改所有ES节点的配置文件</strong></p>
<p>vim /etc/elasticsearch/elasticsearch.yml</p>
<h1 id="添加内容："><a href="#添加内容：" class="headerlink" title="添加内容："></a>添加内容：</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http.cors.allow-headers: Authorization</span><br><span class="line">xpack.security.enabled: true</span><br><span class="line">xpack.security.transport.ssl.enabled: true</span><br><span class="line">xpack.security.transport.ssl.verification_mode: certificate</span><br><span class="line">xpack.security.transport.ssl.keystore.path: elastic-certificates.p12 </span><br><span class="line">xpack.security.transport.ssl.truststore.path: elastic-certificates.p12</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>6.重启各ES节点</strong></p>
<p>systemctl  restart elasticsearch</p>
<p><strong>7.设置密码</strong></p>
<p>在其中一个节点上设置密码即可：</p>
<p>/usr/share/elasticsearch/bin/elasticsearch-setup-passwords interactive</p>
<h3 id="配置kibana用户密码"><a href="#配置kibana用户密码" class="headerlink" title="配置kibana用户密码"></a>配置kibana用户密码</h3><p><strong>1.修改配置文件</strong></p>
<p>vi  /etc/kibana/kibana.yml</p>
<p>elasticsearch.username: “kibana_system”<br>elasticsearch.password: “*****”</p>
<p><strong>2.重启kibana</strong></p>
<p>systemctl restart kibana</p>
<p><strong>3.登录kibana</strong></p>
<p>http:<em>//ip:5601/</em></p>
<p>用户名：elastic</p>
<h3 id="配置logstash用户密码"><a href="#配置logstash用户密码" class="headerlink" title="配置logstash用户密码"></a>配置logstash用户密码</h3><p><strong>1.修改配置文件</strong></p>
<p>vi  /etc/logstash/logstash.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xpack.monitoring.enabled: true</span><br><span class="line">xpack.monitoring.elasticsearch.username: logstash_system</span><br><span class="line">xpack.monitoring.elasticsearch.password: *****</span><br><span class="line">xpack.monitoring.elasticsearch.hosts: [&quot;http://ip:9200&quot;]</span><br></pre></td></tr></table></figure>

<p><strong>2.重启logstash</strong></p>
<p>systemctl  restart  logstash  </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://onos.love/2022/02/21/nfs%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xuy">
      <meta itemprop="description" content="记录工作内容,分享技术经验">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经技术">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/21/nfs%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">NFS文件系统部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-02-21 11:35:28 / 修改时间：13:19:02" itemprop="dateCreated datePublished" datetime="2022-02-21T11:35:28+08:00">2022-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BD%AF%E4%BB%B6%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">软件部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h3><p>NFS(network file system)网络文件系统，类似Windows中的文件夹共享，如下有三台机器A, B, C，它们需要访问同一个目录，目录中都是图片，传统的做法是把这些图片分别放到A, B, C。但是使用NFS只需要放到A上，然后A共享给B和C即可。访问的时候，B和C是通过网络的方式去访问A上的那个目录。</p>
<p>server机（A）：192.168.144.101<br>Client机（B，C）：192.168.144.102  192.168.144.103</p>
<h3 id="一、在A机上安装-NFS-服务器所需的软件包"><a href="#一、在A机上安装-NFS-服务器所需的软件包" class="headerlink" title="一、在A机上安装 NFS 服务器所需的软件包"></a>一、<strong>在A机上安装 NFS 服务器所需的软件包</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install nfs-utils   </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 实际上需要安装两个包nfs-utils和rpcbind, 不过当使用yum安装nfs-utils时会把rpcbind一起安装上</span></span><br></pre></td></tr></table></figure>

<h3 id="二、编辑exports文件，添加从机"><a href="#二、编辑exports文件，添加从机" class="headerlink" title="二、编辑exports文件，添加从机"></a>二、<strong>编辑exports文件，添加从机</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/exports   </span><br><span class="line"></span><br><span class="line">/data/nfs 192.168.144.102(rw,sync,insecure,no_subtree_check,no_root_squash) 192.168.144.103(rw,sync,insecure,no_subtree_check,no_root_squash)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置说明：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这一行分为三个部分：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一部分：/data/nfs ，这个是本地要共享出去的目录。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第二部分：192.168.144.100/120，允许访问的主机，可以是一个IP： 192.168.144.102，也可以是一个IP段：192.168.144.100/120</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第三部分：括号中部分。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rw表示可读写，ro只读；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sync ：同步模式，内存中数据时时写入磁盘；async ：不同步，把内存中数据定期写入磁盘中；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> no_root_squash ：加上这个选项后，root用户就会对共享的目录拥有至高的权限控制，就像是对本机的目录操作一样。不安全，不建议使用；root_squash：和上面的选项对应，root用户对共享目录的权限不高，只有普通用户的权限，即限制了root；all_squash：不管使用NFS的用户是谁，他的身份都会被限定成为一个指定的普通用户身份；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> anonuid/anongid ：要和root_squash 以及all_squash一同使用，用于指定使用NFS的用户限定后的uid和gid，前提是本机的/etc/passwd中存在这个uid和gid。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> fsid=0表示将/opt/nfs整个目录包装成根目录</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="三、启动A机上nfs服务"><a href="#三、启动A机上nfs服务" class="headerlink" title="三、启动A机上nfs服务"></a><strong>三、启动A机上nfs服务</strong></h3><p>先为rpcbind和nfs做开机启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开机启动</span></span><br><span class="line">systemctl enable rpcbind.service    </span><br><span class="line">systemctl enable nfs-server.service    </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 然后分别启动rpcbind和nfs服务：</span></span><br><span class="line">systemctl start rpcbind.service    </span><br><span class="line">systemctl start nfs.service  </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 确认NFS服务器启动成功</span>  </span><br><span class="line">rpcinfo -p   </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看可挂载目录及可连接的IP</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">showmount -e 192.168.144.102</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="四、关闭A机上的防火墙或者给防火墙配置nfs的通过规则"><a href="#四、关闭A机上的防火墙或者给防火墙配置nfs的通过规则" class="headerlink" title="四、关闭A机上的防火墙或者给防火墙配置nfs的通过规则"></a><strong>四、关闭A机上的防火墙或者给防火墙配置nfs的通过规则</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="五、在B，C机上配置clinet端"><a href="#五、在B，C机上配置clinet端" class="headerlink" title="五、在B，C机上配置clinet端"></a><strong>五、在B，C机上配置clinet端</strong></h3><p>1、安装nfs，并启动服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils</span><br><span class="line"></span><br><span class="line">systemctl enable rpcbind.service</span><br><span class="line"></span><br><span class="line">systemctl start rpcbind.service</span><br></pre></td></tr></table></figure>

<p>客户端不需要启动nfs服务，只需要启动rpcbind服务.</p>
<p>2、检查 NFS 服务器端是否有目录共享</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showmount -e 192.168.144.102</span><br></pre></td></tr></table></figure>

<p>3、使用 mount 挂载A服务器端的目录/data/nfs到客户端B的目录/data/nfs下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir /data/nfs   </span><br><span class="line"></span><br><span class="line">[root@localhost ~]# mount -t nfs 192.168.144.102:/data/nfs/ /data/nfs/    </span><br><span class="line"></span><br><span class="line">[root@localhost ~]# df -h    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim /etc/exports  </span><br><span class="line">exportfs  -arv</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 让修改过的配置文件生效</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4、设为开机自动挂载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi  /etc/fstab</span><br><span class="line"></span><br><span class="line">nfs01:/data/nfs    /data/nfs   nfs  defaults  0 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://onos.love/2022/02/21/Kafka%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xuy">
      <meta itemprop="description" content="记录工作内容,分享技术经验">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经技术">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/21/Kafka%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">Kafka集群部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-02-21 11:28:15 / 修改时间：13:18:39" itemprop="dateCreated datePublished" datetime="2022-02-21T11:28:15+08:00">2022-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BD%AF%E4%BB%B6%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">软件部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h2><h3 id="一、前提条件"><a href="#一、前提条件" class="headerlink" title="一、前提条件"></a><strong>一、前提条件</strong></h3><p>1、部署Kafka集群搭建需要服务器至少3台，奇数台</p>
<p>2、Kafka的安装需要java环境，jdk1.8</p>
<p>3、Kafka安装包版本：<a target="_blank" rel="noopener" href="https://mirror-hk.koddos.net/apache/kafka/2.7.0/kafka_2.13-2.7.0.tgz">https://mirror-hk.koddos.net/apache/kafka/2.7.0/kafka_2.13-2.7.0.tgz</a></p>
<p>4、3台机器增加host配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.202.129 kafka-1.local</span><br><span class="line">192.168.202.130 kafka-2.local</span><br><span class="line">192.168.202.131 kafka-3.local</span><br></pre></td></tr></table></figure>

<h3 id="二、Zookeeper集群搭建"><a href="#二、Zookeeper集群搭建" class="headerlink" title="二、Zookeeper集群搭建"></a><strong>二、Zookeeper集群搭建</strong></h3><p>直接使用kafka自带的zookeeper建立zk集群</p>
<p>1、将安装包 kafka_2.13-2.7.0.tgz 上传到/opt 目录下</p>
<p>2、解压：tar -zxvf kafka_2.13-2.7.0.tgz</p>
<p>3、进入目录：cd /opt/kafka_2.13-2.7.0/</p>
<p>4、创建zookeeper目录：mkdir zk_kfk_data</p>
<p>5、进入目录：cd /opt/kafka_2.13-2.7.0/config</p>
<p>6、修改zookeeper.properties文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/opt/kafka_2.13-2.7.0/zk_kfk_data</span><br><span class="line"> </span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line"> </span><br><span class="line">server.1=kafka-1.local:2888:3888</span><br><span class="line">server.2=kafka-2.local:2888:3888</span><br><span class="line">server.3=kafka-3.local:2888:3888</span><br></pre></td></tr></table></figure>

<p>三台机器上的zookeeper.properties文件配置相同，dataDir 为zk的数据目录，server.1、server.2、server.3 为集群信息。</p>
<p>2888端口号是zookeeper服务之间通信的端口</p>
<p>3888端口是zookeeper与其他应用程序通信的端口。</p>
<p><strong>tickTime：CS通信心跳数</strong></p>
<p>Zookeeper 服务器之间或客户端与服务器之间维持心跳的时间间隔，也就是每个 tickTime 时间就会发送一个心跳。</p>
<pre><code>  tickTime以毫秒为单位。

  tickTime：该参数用来定义心跳的间隔时间，zookeeper的客户端和服务端之间也有和web开发里类似的session的概念，而zookeeper里最小的session过期时间就是tickTime的两倍。
</code></pre>
<p><strong>initLimit：LF初始通信时限</strong></p>
<p>集群中的follower服务器(F)与leader服务器(L)之间 初始连接 时能容忍的最多心跳数（tickTime的数量）</p>
<p><strong>syncLimit：LF同步通信时限</strong></p>
<p>集群中的follower服务器(F)与leader服务器(L)之间 请求和应答 之间能容忍的最多心跳数（tickTime的数量）</p>
<p>7、创建myid文件：进入/opt/kafka_2.13-2.7.0/zk_kfk_data目录，创建myid文件，将三台服务器上的myid文件分别写入1，2，3。myid是zookeeper集群用来发现彼此的标识，必须创建，且不能相同。</p>
<p>8、执行启动zookeeper命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup /opt/kafka_2.13-2.7.0/bin/zookeeper-server-start.sh /opt/kafka_2.13-2.7.0/config/zookeeper.properties &gt; /opt/kafka_2.13-2.7.0/zookeeper.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>三台机器都执行启动命令，查看zookeeper的日志文件，没有报错就说明zookeeper集群启动成功了。</strong></p>
</blockquote>
<h3 id="三、Kafka集群搭建"><a href="#三、Kafka集群搭建" class="headerlink" title="三、Kafka集群搭建"></a><strong>三、Kafka集群搭建</strong></h3><p>1、进入目录：cd /opt/kafka_2.13-2.7.0/<br>2、创建kafka日志数据目录：mkdir kafka-logs-1<br>3、进入目录：cd /opt/kafka_2.13-2.7.0/config<br>4、修改server.properties配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//用于区分broker,必须唯一,每台机器只需要一个broker.id</span><br><span class="line">//机器A</span><br><span class="line">broker.id=0</span><br><span class="line">//机器B</span><br><span class="line">broker.id=1</span><br><span class="line">//机器C</span><br><span class="line">broker.id=2</span><br><span class="line"> </span><br><span class="line">//PLAINTEXT表示协议,配置本机IP地址</span><br><span class="line">listeners=PLAINTEXT://kafka-1.local:9092</span><br><span class="line">//PLAINTEXT表示协议,配置本机IP地址,对外公布</span><br><span class="line">advertised.listeners=PLAINTEXT://kafka-1.local:9092</span><br><span class="line">//配置zookeeper的地址,zookeeper集群地址以逗号隔开</span><br><span class="line">zookeeper.connect=kafka-1.local:2181,kafka-2.local:2181,kafka-3.local:2181</span><br><span class="line">//配置数据存放目录</span><br><span class="line">log.dirs=/opt/kafka_2.13-2.7.0/kafka-logs-1</span><br><span class="line"># 消息大小5M</span><br><span class="line">max.request.size=5242880</span><br></pre></td></tr></table></figure>

<p>5、配置其他2台机器，注意服务器地址修改</p>
<p>6、 启动kafka集群：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup /opt/kafka_2.13-2.7.0/bin/kafka-server-start.sh /opt/kafka_2.13-2.7.0/config/server.properties &gt; /opt/kafka_2.13-2.7.0/kafka.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>三个节点均要启动；启动无报错，即搭建成功，注意：配置的时候尽量使用绑定的host，而不是直接IP</strong></p>
</blockquote>
<p>7、停止kafka集群：/opt/kafka_2.13-2.7.0/bin/kafka-server-stop.sh</p>
<h3 id="四、测试Kafka集群"><a href="#四、测试Kafka集群" class="headerlink" title="四、测试Kafka集群"></a><strong>四、测试Kafka集群</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//创建topic,--replication-factor指定副本个数,--partitions指定分区个数</span><br><span class="line">/opt/kafka_2.13-2.7.0/bin/kafka-topics.sh --create --zookeeper kafka-1.local:2181 --replication-factor 2 --partitions 1 --topic test</span><br><span class="line"> </span><br><span class="line">//查看所有的topic信息</span><br><span class="line">/opt/kafka_2.13-2.7.0/bin/kafka-topics.sh --list --zookeeper kafka-1.local:2181</span><br><span class="line"> </span><br><span class="line">//启动生产者</span><br><span class="line">/opt/kafka_2.13-2.7.0/bin/kafka-console-producer.sh --broker-list kafka-1.local:9092,kafka-2.local:9092,kafka-3.local:9092 --topic test</span><br><span class="line">&gt; hello world 1</span><br><span class="line">&gt; hello world 2</span><br><span class="line">&gt; hello world 3</span><br><span class="line"> </span><br><span class="line">//启动消费者</span><br><span class="line">/opt/kafka_2.13-2.7.0/bin/kafka-console-consumer.sh --bootstrap-server kafka-1.local:9092,kafka-2.local:9092,kafka-3.local:9092 --topic test --from-beginning</span><br><span class="line"> </span><br><span class="line">//删除topic</span><br><span class="line">/opt/kafka_2.13-2.7.0/bin/kafka-topics.sh --delete --zookeeper kafka-1.local:2181 --topic test</span><br></pre></td></tr></table></figure>

<h2 id="安全认证与授权"><a href="#安全认证与授权" class="headerlink" title="安全认证与授权"></a>安全认证与授权</h2><h3 id="一、认证范围"><a href="#一、认证范围" class="headerlink" title="一、认证范围"></a><strong>一、认证范围</strong></h3><p>Kafka的认证范围包含如下：</p>
<ul>
<li>Client与Broker之间</li>
<li>Broker与Broker之间</li>
<li>Broker与Zookeeper之间</li>
</ul>
<p>当前Kafka系统支持多种认证机制，包括SSL、SASL（Kerberos、PLAIN、SCRAM）。</p>
<h3 id="二、SCRAM认证"><a href="#二、SCRAM认证" class="headerlink" title="二、SCRAM认证"></a>二、SCRAM认证</h3><p>PLAIN认证有个问题，就是不能动态新增用户，每次添加用户后，需要重启正在运行的Kafka集群才能生效。为此，在生产环境，这种认证方式不符合实际业务场景。而SCRAM不一样，使用SCRAM认证，可以动态新增用户，添加用户后，可以不用重启正在运行的Kafka集群即可进行鉴权。</p>
<p>1、在/opt/kafka_2.13-2.7.0/config目录中，复制server.properties文件并重命名为scram.properties，接着修改服务端配置文件scram.properties，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 设置监听使用SASL而不是SSL</span><br><span class="line">listeners=SASL_PLAINTEXT://kafka-1.local:9092</span><br><span class="line">advertised.listeners=SASL_PLAINTEXT://kafka-1.local:9092</span><br><span class="line"></span><br><span class="line"># 表示开启SCRAM认证机制，并启用SHA-256算法</span><br><span class="line">sasl.enabled.mechanisms=SCRAM-SHA-256</span><br><span class="line"># 表示Broker间通信也要开启SCRAM认证，同样适用SHA-256算法</span><br><span class="line">sasl.mechanism.inter.broker.protocol=SCRAM-SHA-256</span><br><span class="line"># 表示Broker间通信使用SASL</span><br><span class="line">security.inter.broker.protocol=SASL_PLAINTEXT</span><br><span class="line"># 设置身份验证使用的类</span><br><span class="line">authorizer.class.name=kafka.security.authorizer.AclAuthorizer</span><br><span class="line">super.users=User:admin</span><br><span class="line"></span><br><span class="line"># 对所有用户topic可见，要禁用。</span><br><span class="line">allow.everyone.if.no.acl.found=false</span><br></pre></td></tr></table></figure>

<p>2、Zookeeper 中创建用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 添加admin用户</span><br><span class="line">/opt/kafka_2.13-2.7.0/bin/kafka-configs.sh --zookeeper localhost:2191 --alter --add-config &#x27;SCRAM-SHA-256=[password=1qaz2wsx],SCRAM-SHA-512=[password=1qaz2wsx]&#x27; --entity-type users --entity-name admin</span><br><span class="line"># 添加sys用户</span><br><span class="line">/opt/kafka_2.13-2.7.0/bin/kafka-configs.sh --zookeeper localhost:2191 --alter --add-config &#x27;SCRAM-SHA-256=[iterations=8192,password=1qaz2wsx],SCRAM-SHA-512=[password=1qaz2wsx]&#x27; --entity-type users --entity-name sys</span><br></pre></td></tr></table></figure>

<p>查看所有用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/kafka_2.13-2.7.0/bin/kafka-configs.sh --zookeeper localhost:2191 --describe --entity-type users</span><br></pre></td></tr></table></figure>

<p>3、启动Kafka集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#config目录下，新建kafka_server_jaas.conf文件，内容如下</span><br><span class="line">KafkaServer &#123;</span><br><span class="line">org.apache.kafka.common.security.scram.ScramLoginModule required</span><br><span class="line">username=&quot;admin&quot;</span><br><span class="line">password=&quot;1qaz2wsx&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">#bin目录下，新建kafka-scram-start.sh文件，添加内容如下</span><br><span class="line">if [ &quot;x$KAFKA_OPTS&quot; ]; then</span><br><span class="line">export KAFKA_OPTS=&quot;-Djava.security.auth.login.config=/opt/kafka_2.13-2.7.0/config/kafka_server_jaas.conf&quot;</span><br><span class="line">fi</span><br><span class="line">#启动kafka服务端</span><br><span class="line">nohup /opt/kafka_2.13-2.7.0/bin/kafka-scram-start.sh /opt/kafka_2.13-2.7.0/config/scram.properties &gt; /opt/kafka_2.13-2.7.0/kafka.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<p>4、配置用户的ACL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#列出所有主题的ACL设置</span><br><span class="line">/opt/kafka_2.13-2.7.0/bin/kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2191 --list</span><br><span class="line"># 允许 sys 用户读取和写入test主题</span><br><span class="line">/opt/kafka_2.13-2.7.0/bin/kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2191 --add --allow-principal User:sys --operation Read --operation Write --topic test</span><br><span class="line"></span><br><span class="line">#往test主题中发送测试数据</span><br><span class="line">(1)producer.properties 文件加入以下属性</span><br><span class="line">security.protocol=SASL_PLAINTEXT</span><br><span class="line">sasl.mechanism=SCRAM-SHA-256</span><br><span class="line">sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username=&quot;sys&quot; password=&quot;1qaz2wsx&quot;;</span><br><span class="line">(2)运行生产程序</span><br><span class="line">/opt/kafka_2.13-2.7.0/bin/kafka-console-producer.sh --broker-list 192.168.144.101:9092 --topic test --producer.config  /opt/kafka_2.13-2.7.0/config/producer.properties</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://onos.love/2022/02/21/mysql%E5%8F%8C%E4%B8%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xuy">
      <meta itemprop="description" content="记录工作内容,分享技术经验">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正经技术">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/21/mysql%E5%8F%8C%E4%B8%BB/" class="post-title-link" itemprop="url">MySql双主</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-02-21 11:23:46 / 修改时间：13:18:51" itemprop="dateCreated datePublished" datetime="2022-02-21T11:23:46+08:00">2022-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BD%AF%E4%BB%B6%E9%83%A8%E7%BD%B2/" itemprop="url" rel="index"><span itemprop="name">软件部署</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="程序安装"><a href="#程序安装" class="headerlink" title="程序安装"></a>程序安装</h3><p>CentOS 7的yum源中没有正常安装mysql时的mysql-sever文件，需要去官网上下载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载mysql源安装包</span></span><br><span class="line">wget http://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装mysql</span></span><br><span class="line">rpm -ivh mysql57-community-release-el7-9.noarch.rpm</span><br><span class="line">yum install mysql-server</span><br><span class="line">systemctl start mysqld</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 找到初始密码</span></span><br><span class="line">grep &#x27;temporary password&#x27; /var/log/mysqld.log</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 登录修改密码</span></span><br><span class="line">mysql -u root -p</span><br><span class="line">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;1qaz@WSX&#x27;;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启远程</span></span><br><span class="line">use mysql;</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO &#x27;root&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;1qaz@WSX&#x27; WITH GRANT OPTION;</span><br><span class="line">flush privileges;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置默认编码为utf8</span></span><br><span class="line">vi /etc/my.cnf</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加 [mysqld]</span> </span><br><span class="line">character_set_server=utf8 </span><br><span class="line">init_connect=&#x27;SET NAMES utf8&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启/设置开机启动</span></span><br><span class="line">systemctl restart mysqld</span><br><span class="line">systemctl enable mysqld </span><br></pre></td></tr></table></figure>

<hr>
<h3 id="环境描述"><a href="#环境描述" class="headerlink" title="环境描述"></a>环境描述</h3><p>MASTER：192.168.0.202<br>BACKUP：192.168.0.203<br>VIP：192.168.0.204</p>
<h3 id="1、配置两台Mysql主主同步"><a href="#1、配置两台Mysql主主同步" class="headerlink" title="1、配置两台Mysql主主同步"></a>1、配置两台Mysql主主同步</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vi /etc/my.cnf  #开启二进制日志，设置id</span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 1                    #backup这台设置2</span><br><span class="line">log-bin = mysql-bin</span><br><span class="line">binlog-ignore-db = mysql,information_schema       #忽略写入binlog日志的库</span><br><span class="line">auto-increment-increment = 2             #字段变化增量值</span><br><span class="line">auto-increment-offset = 1              #MASTER初始字段ID为1,BACKUP初始字段ID为2</span><br><span class="line">slave-skip-errors = all                       #忽略所有复制产生的错误     </span><br><span class="line">[root@master ~]# systemctl restart mysqld</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝my.cnf文件到另一台服务器，修改auto-increment-offset = 2</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 先查看master <span class="built_in">log</span> bin日志和pos值位置(BACKUP机器为主示例)</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show master status;</span></span><br><span class="line"></span><br><span class="line">[root@ master ~]# mysql -u root -p</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> change master to master_host=<span class="string">&#x27;192.168.0.203&#x27;</span>, master_user=<span class="string">&#x27;root&#x27;</span>, master_password=<span class="string">&#x27;1qaz@WSX&#x27;</span>, master_log_file=<span class="string">&#x27;mysql-bin.000002&#x27;</span>,master_log_pos=106;</span>  </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 说明：192.168.0.203是主服务器的id，master_log_file=<span class="string">&#x27; mysql-bin.000002&#x27;</span>是主服务器的File（你主服务器查出来的是什么就写什么），master_log_pos=106是主服务器的Position（你主服务器查出来的是什么就写什么）；每次重新启动主服务器，master_log_file和master_log_pos都会变。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> start  slave;         <span class="comment">#启动同步</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> backup配置如下：</span></span><br><span class="line">[root@backup ~]#  mysql -u root -p</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> change master to master_host=<span class="string">&#x27;192.168.0.202&#x27;</span>, master_user=<span class="string">&#x27;root&#x27;</span>, master_password=<span class="string">&#x27;1qaz@WSX&#x27;</span>, master_log_file=<span class="string">&#x27;mysql-bin.000002&#x27;</span>,master_log_pos=106;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> start  slave;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主主同步配置完毕，查看同步状态Slave_IO和Slave_SQL是YES说明主主同步成功。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show slave status;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 若 Slave_SQL_Running: no 请重复执行以下内容，直至yes**</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash">stop slave;</span> </span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"><span class="built_in">set</span> GLOBAL SQL_SLAVE_SKIP_COUNTER=1;</span> </span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash">start slave;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在master插入数据测试下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在backup查看是否同步成功：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到已经成功同步过去，同样在backup插入到user表数据，一样同步过去，双主就做成功了。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果主数据库原有数据，从库新建，需要先同步库</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要先把主数据库的备份到从库导出主库</span></span><br><span class="line"></span><br><span class="line">mysqldump -uroot -pabc123 --all-databases &gt; /home/20210414-2.sql</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导入从库</span></span><br><span class="line"></span><br><span class="line">mysql -uroot -pAbc123456. &lt; /home/20210414-2.sql</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 再重启等待</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2，配置keepalived实现热备"><a href="#2，配置keepalived实现热备" class="headerlink" title="2，配置keepalived实现热备"></a>2，配置keepalived实现热备</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 源码安装（方案1）</span></span><br><span class="line">[root@backup ~]# yum install -y pcre-devel openssl-devel popt-devel #安装依赖包</span><br><span class="line">[root@master ~]# wget http://www.keepalived.org/software/keepalived-1.2.7.tar.gz</span><br><span class="line"></span><br><span class="line">[root@master ~]# tar zxvf keepalived-1.2.7.tar.gz</span><br><span class="line">[root@master ~]# cd keepalived-1.2.7</span><br><span class="line">[root@master ~]#./configure --prefix=/usr/local/keepalived</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> yum安装（方案2）</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">将keepalived配置成系统服务（采用方案2，此处略过）</span></span><br><span class="line">[root@master ~]# cp /usr/local/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/</span><br><span class="line">[root@master ~]# cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/</span><br><span class="line">[root@master ~]# mkdir /etc/keepalived/</span><br><span class="line">[root@master ~]# cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/</span><br><span class="line">[root@master ~]# cp /usr/local/keepalived/sbin/keepalived /usr/sbin/</span><br><span class="line"></span><br><span class="line">[root@master ~]# vi /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File forkeepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    notification_email &#123;</span><br><span class="line">        ops@wangshibo.cn</span><br><span class="line">        tech@wangshibo.cn</span><br><span class="line">    &#125;</span><br><span class="line">       </span><br><span class="line">    notification_email_from ops@wangshibo.cn</span><br><span class="line">    smtp_server 127.0.0.1 </span><br><span class="line">    smtp_connect_timeout 30</span><br><span class="line">    router_id MASTER-HA</span><br><span class="line">&#125;</span><br><span class="line">       </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"> state BACKUP           #主从均写成BACKUP</span><br><span class="line"> interface eth0  #本地服务器网卡</span><br><span class="line"> virtual_router_id 51       #主备相同</span><br><span class="line"> priority 150           #优先级，backup设置90</span><br><span class="line"> advert_int 1           #心跳检测</span><br><span class="line"> nopreempt             #不主动抢占资源，只在优先级高的设置</span><br><span class="line"> authentication &#123;</span><br><span class="line"> auth_type PASS</span><br><span class="line"> auth_pass 1111</span><br><span class="line"> &#125;</span><br><span class="line"> virtual_ipaddress &#123;</span><br><span class="line"> 192.168.0.204</span><br><span class="line"> &#125;</span><br><span class="line"> track_script &#123;               </span><br><span class="line"> chk_mysql_port             </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_mysql_port &#123;     #检测mysql服务是否在运行。有很多方式，比如进程，用脚本检测等等</span><br><span class="line">    script &quot;/etc/keepalived/chk_mysql.sh&quot;   #这里通过脚本监测</span><br><span class="line">    interval 2                   #脚本执行间隔，每2s检测一次</span><br><span class="line">    weight -5                    #脚本结果导致的优先级变更，检测失败（脚本返回非0）则优先级 -5</span><br><span class="line">    fall 2                    #检测连续2次失败才算确定是真失败。会用weight减少优先级（1-255之间）</span><br><span class="line">    rise 1                    #检测1次成功就算成功。但不修改优先级</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@master ~]# vi /etc/keepalived/chk_mysql.sh</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">counter=$(netstat -na|grep &quot;LISTEN&quot;|grep &quot;3306&quot;|wc -l)</span><br><span class="line">if [ &quot;$&#123;counter&#125;&quot; -eq 0 ]; then</span><br><span class="line">    systemctl stop keepalived</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">[root@master ~]# chmod +x /etc/keepalived/chk_mysql.sh</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动（方案1）</span></span><br><span class="line">[root@master ~]# /etc/init.d/keepalived start</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动（方案2）</span></span><br><span class="line">[root@master ~]# systemctl enable keepalived</span><br><span class="line">[root@master ~]# systemctl start keepalived</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看运行状况</span></span><br><span class="line">systemctl status keepalived</span><br><span class="line"></span><br><span class="line">查看虚拟IP</span><br><span class="line">[root@master ~]# ip addr show	</span><br></pre></td></tr></table></figure>

<h3 id="3，注意事项"><a href="#3，注意事项" class="headerlink" title="3，注意事项"></a>3，注意事项</h3><p>state BACKUP/MASTER  （主备身份）<br>priority   （权限级别）<br>nopreempt  （非抢占模式）</p>
<p>这三个参数非常重要，由于数据同步是需要时间的，因此，在死机的服务器启动的瞬间，如果把主身份抢走的话，会造成短时间的数据不一致，导致系统错误，因此，需要设置成死机的机器启动成功后也不要抢占主身份。</p>
<p>这里有多种设置：<br>1，可以设置 主备身份之后，把主设置为非抢占模式；<br>2，也可以 把两台服务器都设置成备身份，然后都设置成非抢占模式，权限级别设置成一样。<br>3，还可以都设置成备身份，然后其中一台权限级别设置比另外一个高，然后把高的设置为非抢占模式。</p>
<p>授权两台Mysql服务器允许root远程登录，用于在其他服务器登陆测试！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> grant all on *.* to<span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;192.168.0.%&#x27;</span> identified by <span class="string">&#x27;123.com&#x27;</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush privileges;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="4，测试高可用性"><a href="#4，测试高可用性" class="headerlink" title="4，测试高可用性"></a>4，测试高可用性</h3><p>1、通过Mysql客户端通过VIP连接，看是否连接成功。<br>2、停止master这台mysql服务，是否能正常切换过去，可通过ip addr命令来查看VIP在哪台服务器上。<br>3、可通过查看/var/log/messges日志，看出主备切换过程<br>4、master服务器故障恢复后，是否主动抢占资源，成为活动服务器。</p>
<h3 id="5，测试用例："><a href="#5，测试用例：" class="headerlink" title="5，测试用例："></a>5，测试用例：</h3><p>一，简单用例：<br>1，停止master上的mysql服务，查看数据库是否能正常使用；恢复master上的mysql，查看数据是否同步。<br>2，停止slave上的mysql服务，查看数据库是否能正常使用；恢复slave上的mysql，查看数据是否同步。<br>3，关闭master服务器，查看数据库是否能正常使用；打开master服务器，查看数据是否正常同步。<br>4，关闭slave服务器，查看数据库是否能正常使用；打开slave服务器，查看数据是否正常同步。<br>5，关闭master服务器上的网络服务，查看数据库是否能正常使用；打开master网络服务，查看数据库是否正常同步。<br>6，关比slave服务器上的网络服务，查看数据库是否能正常使用；打开slave网络服务，查看数据库是否正常同步。</p>
<p>二，复杂用例：<br>1，关闭master服务器，再打开master服务器，说明数据库跳到slave机器上；打开master服务器之后，查看数据库连接是否重新跳回master。<br>2，如果不跳回master，同样的操作对slave做一遍</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">www.onos.love | ONOS</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
